à;
jC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Servives\SecurityHeadersService.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Servives 
;  
public 
class "
SecurityHeadersService #
{ 
private 
readonly 

Dictionary 
<  
string  &
,& '
string( .
>. /
_scriptHashes0 =
=> ?
new@ C
(C D
)D E
;E F
private		 
readonly		 

Dictionary		 
<		  
string		  &
,		& '
string		( .
>		. /
_styleHashes		0 <
=		= >
new		? B
(		B C
)		C D
;		D E
public 

string 
ComputeHash 
( 
string $
content% ,
), -
{ 
using 
var 
sha256 
= 
SHA256 !
.! "
Create" (
(( )
)) *
;* +
var 
hash 
= 
sha256 
. 
ComputeHash %
(% &
Encoding& .
.. /
UTF8/ 3
.3 4
GetBytes4 <
(< =
content= D
)D E
)E F
;F G
return 
Convert 
. 
ToBase64String %
(% &
hash& *
)* +
;+ ,
} 
public 

string 
GetScriptHash 
(  
string  &
script' -
)- .
{ 
if 

( 
_scriptHashes 
. 
TryGetValue %
(% &
script& ,
,, -
out. 1
var2 5
hash6 :
): ;
); <
{ 	
return 
hash 
; 
} 	
hash 
= 
ComputeHash 
( 
script !
)! "
;" #
_scriptHashes 
[ 
script 
] 
= 
hash  $
;$ %
return 
hash 
; 
} 
public 

string 
GetStyleHash 
( 
string %
style& +
)+ ,
{ 
if   

(   
_styleHashes   
.   
TryGetValue   $
(  $ %
style  % *
,  * +
out  , /
var  0 3
hash  4 8
)  8 9
)  9 :
{!! 	
return"" 
hash"" 
;"" 
}## 	
hash%% 
=%% 
ComputeHash%% 
(%% 
style%%  
)%%  !
;%%! "
_styleHashes&& 
[&& 
style&& 
]&& 
=&& 
hash&& "
;&&" #
return'' 
hash'' 
;'' 
}(( 
public** 

string** 
GetCSPHeader** 
(** 
string** %
nonce**& +
)**+ ,
{++ 
var,, 
trustedScriptHashes,, 
=,,  !
string,," (
.,,( )
Join,,) -
(,,- .
$str,,. 1
,,,1 2
_scriptHashes,,3 @
.,,@ A
Values,,A G
.,,G H
Select,,H N
(,,N O
h,,O P
=>,,Q S
$",,T V
$str,,V ^
{,,^ _
h,,_ `
},,` a
$str,,a b
",,b c
),,c d
),,d e
;,,e f
var-- 
trustedStyleHashes-- 
=--  
string--! '
.--' (
Join--( ,
(--, -
$str--- 0
,--0 1
_styleHashes--2 >
.--> ?
Values--? E
.--E F
Select--F L
(--L M
h--M N
=>--O Q
$"--R T
$str--T \
{--\ ]
h--] ^
}--^ _
$str--_ `
"--` a
)--a b
)--b c
;--c d
var00 
trustedDomains00 
=00 
new00  
[00  !
]00! "
{11 	
$str22 #
,22# $
$str33 $
,33$ %
$str44 $
,44$ %
$str55 %
,55% &
$str66 (
}77 	
;77	 

var99 #
trustedWebsocketDomains99 #
=99$ %
new99& )
[99) *
]99* +
{:: 	
$str;; !
,;;! "
$str<< "
,<<" #
$str== "
,==" #
$str>> #
}?? 	
;??	 

varAA 
	scriptSrcAA 
=AA 
newAA 
[AA 
]AA 
{BB 	
$strCC 
,CC 
$"DD 
$strDD 
{DD 
nonceDD 
}DD 
$strDD 
"DD 
,DD 
trustedScriptHashesEE 
,EE  
$strFF 
}GG 	
.GG	 

WhereGG
 
(GG 
sGG 
=>GG 
!GG 
stringGG 
.GG 
IsNullOrEmptyGG *
(GG* +
sGG+ ,
)GG, -
)GG- .
;GG. /
varII 

connectSrcII 
=II 
newII 
[II 
]II 
{JJ 	
$strKK 
,KK 
stringLL 
.LL 
JoinLL 
(LL 
$strLL 
,LL 
trustedDomainsLL +
)LL+ ,
,LL, -
stringMM 
.MM 
JoinMM 
(MM 
$strMM 
,MM #
trustedWebsocketDomainsMM 4
)MM4 5
}NN 	
;NN	 

returnPP 
newPP 
StringBuilderPP  
(PP  !
)PP! "
.QQ 
AppendQQ 
(QQ 
$strQQ *
)QQ* +
.RR 
AppendRR 
(RR 
$"RR 
$strRR !
{RR! "
stringRR" (
.RR( )
JoinRR) -
(RR- .
$strRR. 1
,RR1 2
	scriptSrcRR3 <
)RR< =
}RR= >
$strRR> @
"RR@ A
)RRA B
.SS 
AppendSS 
(SS 
$"SS 
$strSS .
{SS. /
nonceSS/ 4
}SS4 5
$strSS5 7
{SS7 8
trustedStyleHashesSS8 J
}SSJ K
$strSSK M
"SSM N
)SSN O
.TT 
AppendTT 
(TT 
$strTT ,
)TT, -
.UU 
AppendUU 
(UU 
$strUU -
)UU- .
.VV 
AppendVV 
(VV 
$"VV 
$strVV "
{VV" #
stringVV# )
.VV) *
JoinVV* .
(VV. /
$strVV/ 2
,VV2 3

connectSrcVV4 >
)VV> ?
}VV? @
$strVV@ B
"VVB C
)VVC D
.WW 
AppendWW 
(WW 
$strWW .
)WW. /
.XX 
AppendXX 
(XX 
$strXX *
)XX* +
.YY 
AppendYY 
(YY 
$strYY '
)YY' (
.ZZ 
AppendZZ 
(ZZ 
$strZZ )
)ZZ) *
.[[ 
Append[[ 
([[ 
$str[[ 0
)[[0 1
.\\ 
ToString\\ 
(\\ 
)\\ 
;\\ 
}]] 
}^^ °
dC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Servives\AuditoriaService.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Servives 
{ 
public 

class 
AuditoriaService !
{ 
private 
readonly 
AuditoriaData &
_auditoriaData' 5
;5 6
public

 
AuditoriaService

 
(

  
AuditoriaData

  -
auditoriaData

. ;
)

; <
{ 	
_auditoriaData 
= 
auditoriaData *
;* +
} 	
public 
async 
Task 
RegistrarLog &
(& '
string' -
usuario. 5
,5 6
string7 =
accion> D
,D E
stringF L
detallesM U
)U V
{ 	
var 
log 
= 
new 
	Auditoria #
{ 
Usuario 
= 
usuario !
,! "
Accion 
= 
accion 
,  
Fecha 
= 
DateTime  
.  !
UtcNow! '
,' (
Detalles 
= 
detalles #
} 
; 
await 
_auditoriaData  
.  !
Insertar! )
() *
log* -
)- .
;. /
} 	
} 
} ¹q
RC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Program.cs
var

 
builder

 
=

 
WebApplication

 
.

 
CreateBuilder

 *
(

* +
args

+ /
)

/ 0
;

0 1
builder 
. 
Services 
. #
AddControllersWithViews (
(( )
)) *
;* +
builder 
. 
Services 
. 
	Configure 
< 
ConnectionStrings ,
>, -
(- .
builder. 5
.5 6
Configuration6 C
.C D

GetSectionD N
(N O
$strO b
)b c
)c d
;d e
builder 
. 
Services 
. 
AddSingleton 
< 
EmailService *
>* +
(+ ,
), -
;- .
builder 
. 
Services 
. 
	Configure 
< 
SmtpSettings '
>' (
(( )
builder) 0
.0 1
Configuration1 >
.> ?

GetSection? I
(I J
$strJ P
)P Q
)Q R
;R S
builder 
. 
Services 
. 
AddSingleton 
< 

MonedaData (
>( )
() *
)* +
;+ ,
builder 
. 
Services 
. 
AddSingleton 
< 
ClienteData )
>) *
(* +
)+ ,
;, -
builder 
. 
Services 
. 
AddSingleton 
< 
PrestamoData *
>* +
(+ ,
), -
;- .
builder 
. 
Services 
. 
AddSingleton 
< 
ResumenData )
>) *
(* +
)+ ,
;, -
builder 
. 
Services 
. 
AddSingleton 
< 
UsuarioData )
>) *
(* +
)+ ,
;, -
builder 
. 
Services 
. 
	AddScoped 
< 
ResumenClienteData -
>- .
(. /
)/ 0
;0 1
builder 
. 
Services 
. 
AddSingleton 
< 
AuditoriaData +
>+ ,
(, -
)- .
;. /
builder 
. 
Services 
. 
	AddScoped 
< 
AuditoriaService +
>+ ,
(, -
)- .
;. /
builder 
. 
Services 
. 
AddSingleton 
< 

CuentaData (
>( )
() *
)* +
;+ ,
builder 
. 
Services 
. 
AddSingleton 
< "
SecurityHeadersService 4
>4 5
(5 6
)6 7
;7 8
builder 
. 
Services 
. 
AddCors 
( 
options  
=>! #
{ 
options   
.   
AddDefaultPolicy   
(   
policy   #
=>  $ &
{!! 
policy"" 
."" 
WithOrigins"" 
("" 
$str## #
,### $
$str$$ $
)%% 	
.&& 	
WithMethods&&	 
(&& 
$str&& 
,&& 
$str&& "
,&&" #
$str&&$ -
)&&- .
.'' 	
WithHeaders''	 
('' 
$str'' #
,''# $
$str''% 4
,''4 5
$str''6 H
)''H I
.(( 	
AllowCredentials((	 
((( 
)(( 
;(( 
})) 
))) 
;)) 
}** 
)** 
;** 
builder-- 
.-- 
Services-- 
.-- 
AddAuthentication-- "
(--" #
options--# *
=>--+ -
{.. 
options// 
.// 
DefaultScheme// 
=// (
CookieAuthenticationDefaults// 8
.//8 9 
AuthenticationScheme//9 M
;//M N
options00 
.00 "
DefaultChallengeScheme00 "
=00# $(
CookieAuthenticationDefaults00% A
.00A B 
AuthenticationScheme00B V
;00V W
options11 
.11 %
DefaultAuthenticateScheme11 %
=11& '(
CookieAuthenticationDefaults11( D
.11D E 
AuthenticationScheme11E Y
;11Y Z
}22 
)22 
.44 
	AddCookie44 

(44
 (
CookieAuthenticationDefaults44 '
.44' ( 
AuthenticationScheme44( <
,44< =
options44> E
=>44F H
{55 
options66 
.66 
	LoginPath66 
=66 
$str66  
;66  !
options77 
.77 
AccessDeniedPath77 
=77 
$str77 '
;77' (
options88 
.88 
ExpireTimeSpan88 
=88 
TimeSpan88 %
.88% &
FromMinutes88& 1
(881 2
$num882 4
)884 5
;885 6
options99 
.99 
Cookie99 
.99 
Name99 
=99 
$str99 (
;99( )
options:: 
.:: 
SlidingExpiration:: 
=:: 
true::  $
;::$ %
options;; 
.;; 
Cookie;; 
.;; 
IsEssential;; 
=;;  
true;;! %
;;;% &
options<< 
.<< 
Cookie<< 
.<< 
SecurePolicy<< 
=<<  !
CookieSecurePolicy<<" 4
.<<4 5
Always<<5 ;
;<<; <
options== 
.== 
Cookie== 
.== 
SameSite== 
=== 
SameSiteMode== *
.==* +
Strict==+ 1
;==1 2
options>> 
.>> 
Cookie>> 
.>> 

Expiration>> 
=>> 
null>>  $
;>>$ %
}?? 
)?? 
.AA 
AddJwtBearerAA 
(AA 
JwtBearerDefaultsAA 
.AA   
AuthenticationSchemeAA  4
,AA4 5
optionsAA6 =
=>AA> @
{BB 
optionsCC 
.CC 
	SaveTokenCC 
=CC 
trueCC 
;CC 
optionsDD 
.DD  
RequireHttpsMetadataDD  
=DD! "
falseDD# (
;DD( )
optionsEE 
.EE %
TokenValidationParametersEE %
=EE& '
newEE( +%
TokenValidationParametersEE, E
{FF 
ValidateIssuerGG 
=GG 
trueGG 
,GG 
ValidateAudienceHH 
=HH 
trueHH 
,HH  
ValidateLifetimeII 
=II 
trueII 
,II  $
ValidateIssuerSigningKeyJJ  
=JJ! "
trueJJ# '
,JJ' (
ValidIssuerKK 
=KK 
builderKK 
.KK 
ConfigurationKK +
[KK+ ,
$strKK, 8
]KK8 9
,KK9 :
ValidAudienceLL 
=LL 
builderLL 
.LL  
ConfigurationLL  -
[LL- .
$strLL. :
]LL: ;
,LL; <
IssuerSigningKeyMM 
=MM 
newMM  
SymmetricSecurityKeyMM 3
(MM3 4
EncodingMM4 <
.MM< =
UTF8MM= A
.MMA B
GetBytesMMB J
(MMJ K
builderMMK R
.MMR S
ConfigurationMMS `
[MM` a
$strMMa j
]MMj k
!MMk l
)MMl m
)MMm n
}NN 
;NN 
optionsOO 
.OO 
EventsOO 
=OO 
newOO 
JwtBearerEventsOO (
{PP 
OnMessageReceivedQQ 
=QQ 
contextQQ #
=>QQ$ &
{QQ' (
contextRR 
.RR 
TokenRR 
=RR 
contextRR #
.RR# $
RequestRR$ +
.RR+ ,
CookiesRR, 3
[RR3 4
$strRR4 B
]RRB C
;RRC D
returnSS 
TaskSS 
.SS 
CompletedTaskSS %
;SS% &
}TT 	
}UU 
;UU 
}VV 
)VV 
;VV 
builderXX 
.XX 
ServicesXX 
.XX 
AddAuthorizationXX !
(XX! "
)XX" #
;XX# $
builder[[ 
.[[ 
Services[[ 
.[[ %
AddDistributedMemoryCache[[ *
([[* +
)[[+ ,
;[[, -
builder\\ 
.\\ 
Services\\ 
.\\ 

AddSession\\ 
(\\ 
options\\ #
=>\\$ &
{]] 
options^^ 
.^^ 
IdleTimeout^^ 
=^^ 
TimeSpan^^ "
.^^" #
FromMinutes^^# .
(^^. /
$num^^/ 1
)^^1 2
;^^2 3
options__ 
.__ 
Cookie__ 
.__ 
HttpOnly__ 
=__ 
true__ "
;__" #
options`` 
.`` 
Cookie`` 
.`` 
IsEssential`` 
=``  
true``! %
;``% &
}aa 
)aa 
;aa 
varcc 
appcc 
=cc 	
buildercc
 
.cc 
Buildcc 
(cc 
)cc 
;cc 
ifff 
(ff 
!ff 
appff 
.ff 	
Environmentff	 
.ff 
IsDevelopmentff "
(ff" #
)ff# $
)ff$ %
{gg 
apphh 
.hh 
UseExceptionHandlerhh 
(hh 
$strhh )
)hh) *
;hh* +
appii 
.ii 
UseHstsii 
(ii 
)ii 
;ii 
}jj 
varmm 
securityHeadersmm 
=mm 
appmm 
.mm 
Servicesmm "
.mm" #
GetRequiredServicemm# 5
<mm5 6"
SecurityHeadersServicemm6 L
>mmL M
(mmM N
)mmN O
;mmO P
appoo 
.oo 
Useoo 
(oo 
asyncoo 
(oo 
contextoo 
,oo 
nextoo 
)oo 
=>oo  
{pp 
varrr 
scriptNoncerr 
=rr 
Convertrr 
.rr 
ToBase64Stringrr ,
(rr, -!
RandomNumberGeneratorrr- B
.rrB C
GetBytesrrC K
(rrK L
$numrrL N
)rrN O
)rrO P
;rrP Q
contextss 
.ss 
Itemsss 
[ss 
$strss 
]ss  
=ss! "
scriptNoncess# .
;ss. /
contextvv 
.vv 
Responsevv 
.vv 
Headersvv 
.vv 
Addvv  
(vv  !
$strvv! 2
,vv2 3
$strvv4 @
)vv@ A
;vvA B
contextyy 
.yy 
Responseyy 
.yy 
Headersyy 
.yy 
Addyy  
(yy  !
$strzz !
,zz! "
securityHeaders{{ 
.{{ 
GetCSPHeader{{ $
({{$ %
scriptNonce{{% 0
){{0 1
)|| 
;|| 
context 
. 
Response 
. 
Headers 
. 
Add  
(  !
$str! 9
,9 :
$str; D
)D E
;E F
context
 
.
 
Response
 
.
 
Headers
 
.
 
Add
  
(
  !
$str
! 2
,
2 3
$str
4 U
)
U V
;
V W
context
 
.
 
Response
 
.
 
Headers
 
.
 
Add
  
(
  !
$str
! 5
,
5 6
$str
 w
)
w x
;
x y
context
 
.
 
Response
 
.
 
Headers
 
.
 
Add
  
(
  !
$str
! ?
,
? @
$str
A O
)
O P
;
P Q
context
 
.
 
Response
 
.
 
Headers
 
.
 
Add
  
(
  !
$str
! =
,
= >
$str
? L
)
L M
;
M N
context
 
.
 
Response
 
.
 
Headers
 
.
 
Add
  
(
  !
$str
! ?
,
? @
$str
A N
)
N O
;
O P
await
 	
next

 
(
 
)
 
;
 
} 
)
 
;
 
app 
.
 
UseCors
 
(
 
)
 
;
 
app 
.
 
UseStaticFiles
 
(
 
)
 
;
 
app 
.
 

UseRouting
 
(
 
)
 
;
 
app 
.
 
UseAuthentication
 
(
 
)
 
;
 
app 
.
 
UseAuthorization
 
(
 
)
 
;
 
app 
.
 

UseSession
 
(
 
)
 
;
 
app 
.
  
MapControllerRoute
 
(
 
name
 
:
 	
$str

 
,
 
pattern
 
:
 
$str
 6
)
6 7
;
7 8
app 
.
 
Run
 
(
 
)
 	
;
	 
Ç
^C:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Models\SmtpSettings.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Models 
{ 
public 

class 
SmtpSettings 
{ 
public 
string 
Host 
{ 
get  
;  !
set" %
;% &
}' (
public 
int 
Port 
{ 
get 
; 
set "
;" #
}$ %
public 
bool 
	EnableSsl 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
UserName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public		 
string		 
Password		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
}

 
} 
cC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Models\PrestamoViewModel.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Models 
{ 
public 

class 
PrestamoViewModel "
{ 
public 
int 

IdPrestamo 
{ 
get  #
;# $
set% (
;( )
}* +
public 
ClienteInfo 
Cliente "
{# $
get% (
;( )
set* -
;- .
}/ 0
public		 
decimal		 
MontoPrestamo		 $
{		% &
get		' *
;		* +
set		, /
;		/ 0
}		1 2
public

 
decimal

 
ValorInteres

 #
{

$ %
get

& )
;

) *
set

+ .
;

. /
}

0 1
public 
decimal 

ValorTotal !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 

MonedaInfo 
Moneda  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
Estado 
{ 
get "
;" #
set$ '
;' (
}) *
public 
string 
FechaCreacion #
{$ %
get& )
;) *
set+ .
;. /
}0 1
} 
public 

class 
ClienteInfo 
{ 
public 
int 
	IdCliente 
{ 
get "
;" #
set$ '
;' (
}) *
public 
string 
Nombre 
{ 
get "
;" #
set$ '
;' (
}) *
public 
string 
Apellido 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
public 

class 

MonedaInfo 
{ 
public 
int 
IdMoneda 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Nombre 
{ 
get "
;" #
set$ '
;' (
}) *
} 
} Ù
`C:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Models\ErrorViewModel.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Models 
{ 
public 

class 
ErrorViewModel 
{ 
public 
string 
? 
	RequestId  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
bool 
ShowRequestId !
=>" $
!% &
string& ,
., -
IsNullOrEmpty- :
(: ;
	RequestId; D
)D E
;E F
} 
}		 ´
iC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Models\ChangePasswordViewModel.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Models 
{ 
public 

class #
ChangePasswordViewModel (
{ 
[ 	
Required	 
] 
[ 	
DataType	 
( 
DataType 
. 
Password #
)# $
]$ %
[		 	
Display			 
(		 
Name		 
=		 
$str		 +
)		+ ,
]		, -
public

 
string

 
CurrentPassword

 %
{

& '
get

( +
;

+ ,
set

- 0
;

0 1
}

2 3
[ 	
Required	 
] 
[ 	
DataType	 
( 
DataType 
. 
Password #
)# $
]$ %
[ 	
Display	 
( 
Name 
= 
$str *
)* +
]+ ,
public 
string 
NewPassword !
{" #
get$ '
;' (
set) ,
;, -
}. /
[ 	
Required	 
] 
[ 	
DataType	 
( 
DataType 
. 
Password #
)# $
]$ %
[ 	
Display	 
( 
Name 
= 
$str 4
)4 5
]5 6
[ 	
Compare	 
( 
$str 
, 
ErrorMessage  ,
=- .
$str/ u
)u v
]v w
public 
string 
ConfirmPassword %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
[ 	
Display	 
( 
Name 
= 
$str 0
)0 1
]1 2
public 
string 
? 
VerificationCode '
{( )
get* -
;- .
set/ 2
;2 3
}4 5
=6 7
null8 <
!< =
;= >
} 
} º¶
rC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\SolicitudPrestamoController.cs
	namespace		 	
Prestamo		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
	Authorize 
] 
public 

class '
SolicitudPrestamoController ,
:- .

Controller/ 9
{ 
private 
readonly 
PrestamoData %
_prestamoData& 3
;3 4
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 
ResumenClienteData +
_resumenClienteData, ?
;? @
private 
readonly 
EmailService %
_emailService& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
public '
SolicitudPrestamoController *
(* +
PrestamoData+ 7
prestamoData8 D
,D E
ClienteDataF Q
clienteDataR ]
,] ^
ResumenClienteData_ q
resumenClienteData	r 
,
 
EmailService
 
emailService
 
,
  
AuditoriaService
¡ ±
auditoriaService
² Â
)
Â Ã
{ 	
_prestamoData 
= 
prestamoData (
;( )
_clienteData 
= 
clienteData &
;& '
_resumenClienteData 
=  !
resumenClienteData" 4
;4 5
_emailService 
= 
emailService (
;( )
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
[!! 	
	Authorize!!	 
(!! !
AuthenticationSchemes!! (
=!!) *
JwtBearerDefaults!!+ <
.!!< = 
AuthenticationScheme!!= Q
)!!Q R
]!!R S
["" 	
HttpGet""	 
]"" 
[## 	
	Authorize##	 
(## 
Roles## 
=## 
$str## $
)##$ %
]##% &
public$$ 
async$$ 
Task$$ 
<$$ 
IActionResult$$ '
>$$' ( 
ObtenerCedulaCliente$$) =
($$= >
)$$> ?
{%% 	
var&& 
correo&& 
=&& 
User&& 
.&& 
	FindFirst&& '
(&&' (

ClaimTypes&&( 2
.&&2 3
Email&&3 8
)&&8 9
?&&9 :
.&&: ;
Value&&; @
;&&@ A
if'' 
('' 
string'' 
.'' 
IsNullOrEmpty'' $
(''$ %
correo''% +
)''+ ,
)'', -
{(( 
return)) 
RedirectToAction)) '
())' (
$str))( /
,))/ 0
$str))1 7
)))7 8
;))8 9
}** 
var,, 
cliente,, 
=,, 
await,, 
_clienteData,,  ,
.,,, -
ObtenerPorCorreo,,- =
(,,= >
correo,,> D
),,D E
;,,E F
if-- 
(-- 
cliente-- 
==-- 
null-- 
)--  
{.. 
return// 
RedirectToAction// '
(//' (
$str//( /
,/// 0
$str//1 7
)//7 8
;//8 9
}00 
return11 
Ok11 
(11 
new11 
{11 
cedula11 "
=11# $
cliente11% ,
.11, -
NroDocumento11- 9
}11: ;
)11; <
;11< =
}33 	
[55 	
	Authorize55	 
(55 !
AuthenticationSchemes55 (
=55) *
JwtBearerDefaults55+ <
.55< = 
AuthenticationScheme55= Q
)55Q R
]55R S
[66 	
HttpPost66	 
]66 
[77 	
	Authorize77	 
(77 
Roles77 
=77 
$str77 $
)77$ %
]77% &
public88 
async88 
Task88 
<88 
IActionResult88 '
>88' (
CrearSolicitud88) 7
(887 8
[888 9
FromBody889 A
]88A B
SolicitudPrestamo88C T
	solicitud88U ^
)88^ _
{99 	
if:: 
(:: 
!:: 

ModelState:: 
.:: 
IsValid:: #
)::# $
{;; 
return<< 

BadRequest<< !
(<<! "

ModelState<<" ,
)<<, -
;<<- .
}== 
var?? 
userId?? 
=?? 
User?? 
.?? 
	FindFirst?? '
(??' (

ClaimTypes??( 2
.??2 3
NameIdentifier??3 A
)??A B
???B C
.??C D
Value??D I
;??I J
if@@ 
(@@ 
userId@@ 
==@@ 
null@@ 
)@@ 
{AA 
returnBB 
JsonBB 
(BB 
newBB 
{BB  !
successBB" )
=BB* +
falseBB, 1
,BB1 2
messageBB3 :
=BB; <
$strBB= U
}BBV W
)BBW X
;BBX Y
}CC 
	solicitudEE 
.EE 
	IdUsuarioEE 
=EE  !
intEE" %
.EE% &
ParseEE& +
(EE+ ,
userIdEE, 2
)EE2 3
;EE3 4
	solicitudFF 
.FF 
EstadoFF 
=FF 
$strFF *
;FF* +
	solicitudGG 
.GG 
FechaSolicitudGG $
=GG% &
DateTimeGG' /
.GG/ 0
NowGG0 3
;GG3 4
ifJJ 
(JJ 
	solicitudJJ 
.JJ 
NumeroHijosJJ %
>JJ& '
$numJJ( )
)JJ) *
{KK 
	solicitudLL 
.LL 
MontoLL 
-=LL  "
	solicitudLL# ,
.LL, -
NumeroHijosLL- 8
*LL9 :
$numLL; >
;LL> ?
}MM 
varPP 
	historialPP 
=PP 
awaitPP !
_prestamoDataPP" /
.PP/ 0&
ObtenerHistorialCrediticioPP0 J
(PPJ K
	solicitudPPK T
.PPT U
	IdUsuarioPPU ^
)PP^ _
;PP_ `
ifQQ 
(QQ 
	historialQQ 
==QQ 
nullQQ !
)QQ! "
{RR 
	historialSS 
=SS 
newSS 
	EntidadesSS  )
.SS) *
HistorialCrediticioSS* =
{SS> ?
	IdUsuarioSS@ I
=SSJ K
	solicitudSSL U
.SSU V
	IdUsuarioSSV _
,SS_ `
EstadoCrediticioSSa q
=SSr s
$numSSt u
}SSv w
;SSw x
awaitTT 
_auditoriaServiceTT '
.TT' (
RegistrarLogTT( 4
(TT4 5
UserTT5 9
.TT9 :
IdentityTT: B
.TTB C
NameTTC G
,TTG H
$strTTI P
,TTP Q
$"TTR T
$str	TTT 
{
TT 
	solicitud
TT 
.
TT 
	IdUsuario
TT 
}
TT 
"
TT 
)
TT 
;
TT 
awaitUU 
_prestamoDataUU #
.UU# $$
CrearHistorialCrediticioUU$ <
(UU< =
	historialUU= F
)UUF G
;UUG H
}VV 
elseWW 
ifWW 
(WW 
	historialWW 
.WW 
EstadoCrediticioWW /
<WW0 1
$numWW2 3
)WW3 4
{XX 
returnYY 
JsonYY 
(YY 
newYY 
{YY  !
successYY" )
=YY* +
falseYY, 1
,YY1 2
messageYY3 :
=YY; <
$strYY= y
}YYz {
)YY{ |
;YY| }
}ZZ 
var]] 
correo]] 
=]] 
User]] 
.]] 
	FindFirst]] '
(]]' (

ClaimTypes]]( 2
.]]2 3
Email]]3 8
)]]8 9
?]]9 :
.]]: ;
Value]]; @
;]]@ A
var^^ 
cliente^^ 
=^^ 
await^^ 
_clienteData^^  ,
.^^, -
ObtenerPorCorreo^^- =
(^^= >
correo^^> D
)^^D E
;^^E F
var__ 
prestamo__ 
=__ 
await__  
_prestamoData__! .
.__. /'
ObtenerIdPrestamoPorCliente__/ J
(__J K
cliente__K R
.__R S
	IdCliente__S \
)__\ ]
;__] ^
var`` 
resumen`` 
=`` 
await`` 
_resumenClienteData``  3
.``3 4
ObtenerResumen``4 B
(``B C
cliente``C J
.``J K
	IdCliente``K T
,``T U
prestamo``V ^
)``^ _
;``_ `
ifbb 
(bb 
resumenbb 
.bb "
PagosClientePendientesbb .
!=bb/ 1
$strbb2 5
)bb5 6
{cc 
returndd 
Jsondd 
(dd 
newdd 
{dd  !
successdd" )
=dd* +
falsedd, 1
,dd1 2
messagedd3 :
=dd; <
$strdd= p
}ddq r
)ddr s
;dds t
}ee 
ifhh 
(hh 
	solicitudhh 
.hh 
Montohh 
>hh  !
	solicitudhh" +
.hh+ ,
Sueldohh, 2
*hh3 4
$numhh5 6
)hh6 7
{ii 
returnjj 
Jsonjj 
(jj 
newjj 
{jj  !
successjj" )
=jj* +
falsejj, 1
,jj1 2
messagejj3 :
=jj; <
$strjj= z
}jj{ |
)jj| }
;jj} ~
}kk 
trymm 
{nn 
booloo 
	resultadooo 
=oo  
awaitoo! &
_prestamoDataoo' 4
.oo4 5"
CrearSolicitudPrestamooo5 K
(ooK L
	solicitudooL U
)ooU V
;ooV W
ifpp 
(pp 
	resultadopp 
)pp 
{qq 
awaitrr 
_auditoriaServicerr +
.rr+ ,
RegistrarLogrr, 8
(rr8 9
Userrr9 =
.rr= >
Identityrr> F
.rrF G
NamerrG K
,rrK L
$strrrM T
,rrT U
$"rrV X
$str	rrX 
{
rr 
	solicitud
rr 
.
rr 
	IdUsuario
rr 
}
rr 
"
rr  
)
rr  ¡
;
rr¡ ¢
}ss 
returntt 
Jsontt 
(tt 
newtt 
{tt  !
successtt" )
=tt* +
	resultadott, 5
}tt6 7
)tt7 8
;tt8 9
}uu 
catchvv 
(vv 
	Exceptionvv 
exvv 
)vv  
{ww 
returnxx 
Jsonxx 
(xx 
newxx 
{xx  !
successxx" )
=xx* +
falsexx, 1
,xx1 2
messagexx3 :
=xx; <
exxx= ?
.xx? @
Messagexx@ G
}xxH I
)xxI J
;xxJ K
}yy 
}zz 	
[}} 	
	Authorize}}	 
(}} 
Roles}} 
=}} 
$str}} *
)}}* +
]}}+ ,
public~~ 
IActionResult~~  
GestionarSolicitudes~~ 1
(~~1 2
)~~2 3
{ 	
return
 
View
 
(
 
)
 
;
 
}
 	
[
 	
	Authorize
	 
(
 #
AuthenticationSchemes
 (
=
) *
JwtBearerDefaults
+ <
.
< ="
AuthenticationScheme
= Q
)
Q R
]
R S
[
 	
	Authorize
	 
(
 
Roles
 
=
 
$str
 *
)
* +
]
+ ,
[
 	
HttpGet
	 
]
 
public
 
async
 
Task
 
<
 
IActionResult
 '
>
' (*
ObtenerSolicitudesPendientes
) E
(
E F
)
F G
{
 	
var
 
solicitudes
 
=
 
await
 #
_prestamoData
$ 1
.
1 2*
ObtenerSolicitudesPendientes
2 N
(
N O
)
O P
;
P Q
return
 
Json
 
(
 
new
 
{
 
data
 "
=
# $
solicitudes
% 0
}
1 2
)
2 3
;
3 4
}
 	
[
 	
	Authorize
	 
(
 #
AuthenticationSchemes
 (
=
) *
JwtBearerDefaults
+ <
.
< ="
AuthenticationScheme
= Q
)
Q R
]
R S
[
 	
	Authorize
	 
(
 
Roles
 
=
 
$str
 *
)
* +
]
+ ,
[
 	
HttpGet
	 
]
 
public
 
async
 
Task
 
<
 
IActionResult
 '
>
' (
ObtenerSolicitud
) 9
(
9 :
int
: =
id
> @
)
@ A
{
 	
if
 
(
 
!
 

ModelState
 
.
 
IsValid
 #
)
# $
{
 
return
 

BadRequest
 !
(
! "

ModelState
" ,
)
, -
;
- .
}
 
var
 
	solicitud
 
=
 
await
 !
_prestamoData
" /
.
/ 0#
ObtenerSolicitudPorId
0 E
(
E F
id
F H
)
H I
;
I J
if
 
(
 
	solicitud
 
==
 
null
 !
)
! "
{
 
return
 
Json
 
(
 
new
 
{
  !
success
" )
=
* +
false
, 1
,
1 2
message
3 :
=
; <
$str
= V
}
W X
)
X Y
;
Y Z
}
 
return
 
Json
 
(
 
new
 
{
 
success
 %
=
& '
true
( ,
,
, -
data
. 2
=
3 4
	solicitud
5 >
}
? @
)
@ A
;
A B
}
 	
[
 	
	Authorize
	 
(
 #
AuthenticationSchemes
 (
=
) *
JwtBearerDefaults
+ <
.
< ="
AuthenticationScheme
= Q
)
Q R
]
R S
[
 	
	Authorize
	 
(
 
Roles
 
=
 
$str
 *
)
* +
]
+ ,
[
 	
HttpPost
	 
]
 
public
   
async
   
Task
   
<
   
IActionResult
   '
>
  ' ('
ActualizarEstadoSolicitud
  ) B
(
  B C
[
  C D
FromBody
  D L
]
  L M*
SolicitudEstadoUpdateRequest
  N j
request
  k r
)
  r s
{
¡¡ 	
if
¢¢ 
(
¢¢ 
!
¢¢ 

ModelState
¢¢ 
.
¢¢ 
IsValid
¢¢ #
)
¢¢# $
{
££ 
return
¤¤ 

BadRequest
¤¤ !
(
¤¤! "

ModelState
¤¤" ,
)
¤¤, -
;
¤¤- .
}
¥¥ 
try
¦¦ 
{
§§ 
bool
¨¨ 
	resultado
¨¨ 
=
¨¨  
await
¨¨! &
_prestamoData
¨¨' 4
.
¨¨4 5'
ActualizarEstadoSolicitud
¨¨5 N
(
¨¨N O
request
¨¨O V
.
¨¨V W
Id
¨¨W Y
,
¨¨Y Z
request
¨¨[ b
.
¨¨b c
Estado
¨¨c i
)
¨¨i j
;
¨¨j k
if
©© 
(
©© 
	resultado
©© 
)
©© 
{
ªª 
var
«« 
	solicitud
«« !
=
««" #
await
««$ )
_prestamoData
««* 7
.
««7 8#
ObtenerSolicitudPorId
««8 M
(
««M N
request
««N U
.
««U V
Id
««V X
)
««X Y
;
««Y Z
if
¬¬ 
(
¬¬ 
	solicitud
¬¬ !
==
¬¬" $
null
¬¬% )
)
¬¬) *
{
­­ 
return
®® 
Json
®® #
(
®®# $
new
®®$ '
{
®®( )
success
®®* 1
=
®®2 3
false
®®4 9
,
®®9 :
message
®®; B
=
®®C D
$str
®®E ^
}
®®_ `
)
®®` a
;
®®a b
}
¯¯ 
var
±± 
cliente
±± 
=
±±  !
await
±±" '
_clienteData
±±( 4
.
±±4 5
ObtenerPorCedula
±±5 E
(
±±E F
	solicitud
±±F O
.
±±O P
Cedula
±±P V
)
±±V W
;
±±W X
if
²² 
(
²² 
cliente
²² 
==
²²  "
null
²²# '
)
²²' (
{
³³ 
return
´´ 
Json
´´ #
(
´´# $
new
´´$ '
{
´´( )
success
´´* 1
=
´´2 3
false
´´4 9
,
´´9 :
message
´´; B
=
´´C D
$str
´´E \
}
´´] ^
)
´´^ _
;
´´_ `
}
µµ 
if
·· 
(
·· 
request
·· 
.
··  
Estado
··  &
==
··' )
$str
··* 5
)
··5 6
{
¸¸ 
string
¹¹ 
asunto
¹¹ %
=
¹¹& '
$str
¹¹( I
;
¹¹I J
string
ºº 
mensaje
ºº &
=
ºº' (
$"
ºº) +
$str
ºº+ 4
{
ºº4 5
cliente
ºº5 <
.
ºº< =
Nombre
ºº= C
+
ººD E
$str
ººF I
+
ººJ K
cliente
ººL S
.
ººS T
Apellido
ººT \
}
ºº\ ]
$strºº] á
"ººá â
;ººâ ã
await
»» 
_auditoriaService
»» /
.
»»/ 0
RegistrarLog
»»0 <
(
»»< =
User
»»= A
.
»»A B
Identity
»»B J
.
»»J K
Name
»»K O
,
»»O P
$str
»»Q ]
,
»»] ^
$"
»»_ a
$str»»a 
{»» 
cliente»» 
.»» 
	IdCliente»» ¨
}»»¨ ©
"»»© ª
)»»ª «
;»»« ¬
await
¼¼ 
_emailService
¼¼ +
.
¼¼+ ,
EnviarCorreoAsync
¼¼, =
(
¼¼= >
cliente
¼¼> E
.
¼¼E F
Correo
¼¼F L
,
¼¼L M
asunto
¼¼N T
,
¼¼T U
mensaje
¼¼V ]
)
¼¼] ^
;
¼¼^ _
}
½½ 
else
¾¾ 
if
¾¾ 
(
¾¾ 
request
¾¾ $
.
¾¾$ %
Estado
¾¾% +
==
¾¾, .
$str
¾¾/ 9
)
¾¾9 :
{
¿¿ 
var
ÁÁ 
	historial
ÁÁ %
=
ÁÁ& '
await
ÁÁ( -
_prestamoData
ÁÁ. ;
.
ÁÁ; <(
ObtenerHistorialCrediticio
ÁÁ< V
(
ÁÁV W
	solicitud
ÁÁW `
.
ÁÁ` a
	IdUsuario
ÁÁa j
)
ÁÁj k
;
ÁÁk l
if
ÂÂ 
(
ÂÂ 
	historial
ÂÂ %
!=
ÂÂ& (
null
ÂÂ) -
)
ÂÂ- .
{
ÃÃ 
await
ÄÄ !
_prestamoData
ÄÄ" /
.
ÄÄ/ 0+
ActualizarHistorialCrediticio
ÄÄ0 M
(
ÄÄM N
	historial
ÄÄN W
.
ÄÄW X
	IdUsuario
ÄÄX a
,
ÄÄa b
true
ÄÄc g
)
ÄÄg h
;
ÄÄh i
}
ÅÅ 
string
ÇÇ 
asunto
ÇÇ %
=
ÇÇ& '
$str
ÇÇ( H
;
ÇÇH I
string
ÈÈ 
mensaje
ÈÈ &
=
ÈÈ' (
$"
ÈÈ) +
$str
ÈÈ+ 4
{
ÈÈ4 5
cliente
ÈÈ5 <
.
ÈÈ< =
Nombre
ÈÈ= C
+
ÈÈD E
$str
ÈÈF I
+
ÈÈJ K
cliente
ÈÈL S
.
ÈÈS T
Apellido
ÈÈT \
}
ÈÈ\ ]
$strÈÈ] Ø
"ÈÈØ Ù
;ÈÈÙ Ú
await
ÉÉ 
_emailService
ÉÉ +
.
ÉÉ+ ,
EnviarCorreoAsync
ÉÉ, =
(
ÉÉ= >
cliente
ÉÉ> E
.
ÉÉE F
Correo
ÉÉF L
,
ÉÉL M
asunto
ÉÉN T
,
ÉÉT U
mensaje
ÉÉV ]
)
ÉÉ] ^
;
ÉÉ^ _
await
ÊÊ 
_auditoriaService
ÊÊ /
.
ÊÊ/ 0
RegistrarLog
ÊÊ0 <
(
ÊÊ< =
User
ÊÊ= A
.
ÊÊA B
Identity
ÊÊB J
.
ÊÊJ K
Name
ÊÊK O
,
ÊÊO P
$str
ÊÊQ ]
,
ÊÊ] ^
$"
ÊÊ_ a
$strÊÊa 
{ÊÊ 
clienteÊÊ 
.ÊÊ 
	IdClienteÊÊ §
}ÊÊ§ ¨
"ÊÊ¨ ©
)ÊÊ© ª
;ÊÊª «
return
ÌÌ 
Json
ÌÌ #
(
ÌÌ# $
new
ÌÌ$ '
{
ÌÌ( )
success
ÌÌ* 1
=
ÌÌ2 3
true
ÌÌ4 8
,
ÌÌ8 9
redirectUrl
ÌÌ: E
=
ÌÌF G
$str
ÌÌH Y
,
ÌÌY Z
	historial
ÌÌ[ d
}
ÌÌe f
)
ÌÌf g
;
ÌÌg h
}
ÍÍ 
}
ÎÎ 
return
ÏÏ 
Json
ÏÏ 
(
ÏÏ 
new
ÏÏ 
{
ÏÏ  !
success
ÏÏ" )
=
ÏÏ* +
	resultado
ÏÏ, 5
}
ÏÏ6 7
)
ÏÏ7 8
;
ÏÏ8 9
}
ÐÐ 
catch
ÑÑ 
(
ÑÑ 
	Exception
ÑÑ 
ex
ÑÑ 
)
ÑÑ  
{
ÒÒ 
Console
ÔÔ 
.
ÔÔ 
	WriteLine
ÔÔ !
(
ÔÔ! "
ex
ÔÔ" $
.
ÔÔ$ %
Message
ÔÔ% ,
)
ÔÔ, -
;
ÔÔ- .
return
ÕÕ 

StatusCode
ÕÕ !
(
ÕÕ! "
StatusCodes
ÕÕ" -
.
ÕÕ- .*
Status500InternalServerError
ÕÕ. J
,
ÕÕJ K
new
ÕÕL O
{
ÕÕP Q
success
ÕÕR Y
=
ÕÕZ [
false
ÕÕ\ a
,
ÕÕa b
message
ÕÕc j
=
ÕÕk l
$strÕÕm 
}ÕÕ 
)ÕÕ 
;ÕÕ  
}
ÖÖ 
}
×× 	
public
ÙÙ 
class
ÙÙ *
SolicitudEstadoUpdateRequest
ÙÙ 1
{
ÚÚ 	
public
ÛÛ 
int
ÛÛ 
Id
ÛÛ 
{
ÛÛ 
get
ÛÛ 
;
ÛÛ  
set
ÛÛ! $
;
ÛÛ$ %
}
ÛÛ& '
public
ÜÜ 
string
ÜÜ 
Estado
ÜÜ  
{
ÜÜ! "
get
ÜÜ# &
;
ÜÜ& '
set
ÜÜ( +
;
ÜÜ+ ,
}
ÜÜ- .
}
ÝÝ 	
}
ÞÞ 
}ßß º3
iC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\RegisterController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
public 

class 
RegisterController #
:$ %

Controller& 0
{ 
private 
readonly 
UsuarioData $
_usuarioData% 1
;1 2
public 
RegisterController !
(! "
UsuarioData" -
usuarioData. 9
)9 :
{ 	
_usuarioData 
= 
usuarioData &
;& '
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
[ 	
HttpPost	 
] 
[ 	$
ValidateAntiForgeryToken	 !
]! "
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
string/ 5
nombreCompleto6 D
,D E
stringF L
correoM S
,S T
stringU [
clave\ a
)a b
{   	
if!! 
(!! 
string!! 
.!! 
IsNullOrEmpty!! $
(!!$ %
nombreCompleto!!% 3
)!!3 4
||!!5 7
string!!8 >
.!!> ?
IsNullOrEmpty!!? L
(!!L M
correo!!M S
)!!S T
||!!U W
string!!X ^
.!!^ _
IsNullOrEmpty!!_ l
(!!l m
clave!!m r
)!!r s
)!!s t
{"" 
ViewData## 
[## 
$str## "
]##" #
=##$ %
$str##& I
;##I J
return$$ 
View$$ 
($$ 
)$$ 
;$$ 
}%% 
if(( 
((( 
!(( 
Regex(( 
.(( 
IsMatch(( 
((( 
correo(( %
,((% &
$str((' D
,((D E
RegexOptions((F R
.((R S
None((S W
,((W X
TimeSpan((Y a
.((a b
FromMilliseconds((b r
(((r s
$num((s v
)((v w
)((w x
)((x y
{)) 
ViewData** 
[** 
$str** "
]**" #
=**$ %
$str**& O
;**O P
return++ 
View++ 
(++ 
)++ 
;++ 
},, 
var// 
usuarioExistente//  
=//! "
await//# (
_usuarioData//) 5
.//5 6
ObtenerPorCorreo//6 F
(//F G
correo//G M
)//M N
;//N O
if00 
(00 
usuarioExistente00  
!=00! #
null00$ (
)00( )
{11 
ViewData22 
[22 
$str22 "
]22" #
=22$ %
$str22& P
;22P Q
return33 
View33 
(33 
)33 
;33 
}44 
string77 
hashedClave77 
=77  
BCrypt77! '
.77' (
Net77( +
.77+ ,
BCrypt77, 2
.772 3
HashPassword773 ?
(77? @
clave77@ E
)77E F
;77F G
Usuario99 
nuevoUsuario99  
=99! "
new99# &
Usuario99' .
{:: 
NombreCompleto;; 
=;;  
nombreCompleto;;! /
,;;/ 0
Correo<< 
=<< 
correo<< 
,<<  
Clave== 
=== 
hashedClave== #
,==# $
Rol>> 
=>> 
$str>> %
}?? 
;?? 
boolAA 
usuarioCreadoAA 
=AA  
awaitAA! &
_usuarioDataAA' 3
.AA3 4
CrearAA4 9
(AA9 :
nuevoUsuarioAA: F
)AAF G
;AAG H
ifCC 
(CC 
!CC 
usuarioCreadoCC 
)CC 
{DD 
ViewDataEE 
[EE 
$strEE "
]EE" #
=EE$ %
$strEE& A
;EEA B
returnFF 
ViewFF 
(FF 
)FF 
;FF 
}GG 
ViewDataII 
[II 
$strII 
]II 
=II  !
$strII" ?
;II? @
ListLL 
<LL 
ClaimLL 
>LL 
claimsLL 
=LL  
newLL! $
ListLL% )
<LL) *
ClaimLL* /
>LL/ 0
{MM 
newNN 
ClaimNN 
(NN 

ClaimTypesNN $
.NN$ %
NameNN% )
,NN) *
nuevoUsuarioNN+ 7
.NN7 8
NombreCompletoNN8 F
)NNF G
,NNG H
newOO 
ClaimOO 
(OO 

ClaimTypesOO $
.OO$ %
NameIdentifierOO% 3
,OO3 4
nuevoUsuarioOO5 A
.OOA B
	IdUsuarioOOB K
.OOK L
ToStringOOL T
(OOT U
)OOU V
)OOV W
,OOW X
newPP 
ClaimPP 
(PP 

ClaimTypesPP $
.PP$ %
RolePP% )
,PP) *
nuevoUsuarioPP+ 7
.PP7 8
RolPP8 ;
)PP; <
}QQ 
;QQ 
ClaimsIdentitySS 
claimsIdentitySS )
=SS* +
newSS, /
ClaimsIdentitySS0 >
(SS> ?
claimsSS? E
,SSE F(
CookieAuthenticationDefaultsSSG c
.SSc d 
AuthenticationSchemeSSd x
)SSx y
;SSy z$
AuthenticationPropertiesTT $

propertiesTT% /
=TT0 1
newTT2 5$
AuthenticationPropertiesTT6 N
{UU 
AllowRefreshVV 
=VV 
trueVV #
}WW 
;WW 
awaitYY 
HttpContextYY 
.YY 
SignInAsyncYY )
(YY) *(
CookieAuthenticationDefaultsYY* F
.YYF G 
AuthenticationSchemeYYG [
,YY[ \
newYY] `
ClaimsPrincipalYYa p
(YYp q
claimsIdentityYYq 
)	YY 
,
YY 

properties
YY 
)
YY 
;
YY 
returnZZ 
RedirectToActionZZ #
(ZZ# $
$strZZ$ +
,ZZ+ ,
$strZZ- 3
)ZZ3 4
;ZZ4 5
}[[ 	
}\\ 
}]] ÷©
iC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\PrestamoController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
[ 
	Authorize 
] 
public 

class 
PrestamoController #
:$ %

Controller& 0
{ 
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 
PrestamoData %
_prestamoData& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
PrestamoController !
(! "
ClienteData" -
clienteData. 9
,9 :
PrestamoData; G
prestamoDataH T
,T U
AuditoriaServiceV f
auditoriaServiceg w
)w x
{ 	
_clienteData 
= 
clienteData &
;& '
_prestamoData 
= 
prestamoData (
;( )
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
public   
IActionResult   
Nuevo   "
(  " #
)  # $
{!! 	
return"" 
View"" 
("" 
)"" 
;"" 
}## 	
[%% 	
	Authorize%%	 
(%% !
AuthenticationSchemes%% (
=%%) *
JwtBearerDefaults%%+ <
.%%< = 
AuthenticationScheme%%= Q
)%%Q R
]%%R S
[&& 	
HttpGet&&	 
]&& 
['' 	
	Authorize''	 
('' 
Roles'' 
='' 
$str'' 2
)''2 3
]''3 4
public(( 
async(( 
Task(( 
<(( 
IActionResult(( '
>((' (
ObtenerCliente(() 7
(((7 8
string((8 >
NroDocumento((? K
)((K L
{)) 	
Cliente** 
objeto** 
=** 
await** "
_clienteData**# /
.**/ 0
Obtener**0 7
(**7 8
NroDocumento**8 D
)**D E
;**E F
return++ 

StatusCode++ 
(++ 
StatusCodes++ )
.++) *
Status200OK++* 5
,++5 6
new++7 :
{++; <
data++= A
=++B C
objeto++D J
}++K L
)++L M
;++M N
},, 	
[.. 	
	Authorize..	 
(.. !
AuthenticationSchemes.. (
=..) *
JwtBearerDefaults..+ <
...< = 
AuthenticationScheme..= Q
)..Q R
]..R S
[// 	
HttpGet//	 
]// 
[00 	
	Authorize00	 
(00 
Roles00 
=00 
$str00 3
)003 4
]004 5
public11 
async11 
Task11 
<11 
IActionResult11 '
>11' ( 
ObtenerCedulaCliente11) =
(11= >
)11> ?
{22 	
var33 
correo33 
=33 
User33 
.33 
	FindFirst33 '
(33' (

ClaimTypes33( 2
.332 3
Email333 8
)338 9
?339 :
.33: ;
Value33; @
;33@ A
Console44 
.44 
	WriteLine44 
(44 
correo44 $
)44$ %
;44% &
if55 
(55 
string55 
.55 
IsNullOrEmpty55 $
(55$ %
correo55% +
)55+ ,
)55, -
{66 
return77 
RedirectToAction77 '
(77' (
$str77( /
,77/ 0
$str771 7
)777 8
;778 9
}88 
var:: 
cliente:: 
=:: 
await:: 
_clienteData::  ,
.::, -
ObtenerPorCorreo::- =
(::= >
correo::> D
)::D E
;::E F
Console;; 
.;; 
	WriteLine;; 
(;; 
cliente;; %
.;;% &
NroDocumento;;& 2
);;2 3
;;;3 4
if<< 
(<< 
cliente<< 
==<< 
null<< 
)<<  
{== 
return>> 
RedirectToAction>> '
(>>' (
$str>>( /
,>>/ 0
$str>>1 7
)>>7 8
;>>8 9
}?? 
return@@ 
Ok@@ 
(@@ 
new@@ 
{@@ 
cedula@@ "
=@@# $
cliente@@% ,
.@@, -
NroDocumento@@- 9
}@@: ;
)@@; <
;@@< =
}BB 	
[DD 	
	AuthorizeDD	 
(DD !
AuthenticationSchemesDD (
=DD) *
JwtBearerDefaultsDD+ <
.DD< = 
AuthenticationSchemeDD= Q
)DDQ R
]DDR S
[EE 	
HttpPostEE	 
]EE 
[FF 	
	AuthorizeFF	 
(FF 
RolesFF 
=FF 
$strFF *
)FF* +
]FF+ ,
publicGG 
asyncGG 
TaskGG 
<GG 
IActionResultGG '
>GG' (
CrearGG) .
(GG. /
[GG/ 0
FromBodyGG0 8
]GG8 9
PrestamoGG: B
.GGB C
	EntidadesGGC L
.GGL M
PrestamoGGM U
objetoGGV \
)GG\ ]
{HH 	
ifII 
(II 
!II 

ModelStateII 
.II 
IsValidII #
)II# $
{JJ 
returnKK 

BadRequestKK !
(KK! "

ModelStateKK" ,
)KK, -
;KK- .
}LL 
stringMM 
	respuestaMM 
=MM 
awaitMM $
_prestamoDataMM% 2
.MM2 3
CrearMM3 8
(MM8 9
objetoMM9 ?
)MM? @
;MM@ A
awaitNN 
_auditoriaServiceNN #
.NN# $
RegistrarLogNN$ 0
(NN0 1
UserNN1 5
.NN5 6
IdentityNN6 >
.NN> ?
NameNN? C
,NNC D
$strNNE L
,NNL M
$"NNN P
$strNNP a
{NNa b
objetoNNb h
.NNh i

IdPrestamoNNi s
}NNs t
"NNt u
)NNu v
;NNv w
returnOO 

StatusCodeOO 
(OO 
StatusCodesOO )
.OO) *
Status200OKOO* 5
,OO5 6
newOO7 :
{OO; <
dataOO= A
=OOB C
	respuestaOOD M
}OON O
)OOO P
;OOP Q
}PP 	
[RR 	
	AuthorizeRR	 
(RR !
AuthenticationSchemesRR (
=RR) *
JwtBearerDefaultsRR+ <
.RR< = 
AuthenticationSchemeRR= Q
)RRQ R
]RRR S
[SS 	
HttpGetSS	 
]SS 
[TT 	
	AuthorizeTT	 
(TT 
RolesTT 
=TT 
$strTT 3
)TT3 4
]TT4 5
publicUU 
asyncUU 
TaskUU 
<UU 
IActionResultUU '
>UU' (
ObtenerPrestamosUU) 9
(UU9 :
intUU: =

IdPrestamoUU> H
,UUH I
stringUUJ P
NroDocumentoUUQ ]
)UU] ^
{VV 	
ListWW 
<WW 
PrestamoWW 
.WW 
	EntidadesWW #
.WW# $
PrestamoWW$ ,
>WW, -
objetoWW. 4
=WW5 6
awaitWW7 <
_prestamoDataWW= J
.WWJ K
ObtenerPrestamosWWK [
(WW[ \

IdPrestamoWW\ f
,WWf g
NroDocumentoWWg s
==WWt v
nullWWw {
?WW| }
$str	WW~ 
:
WW 
NroDocumento
WW 
)
WW 
;
WW 
returnXX 

StatusCodeXX 
(XX 
StatusCodesXX )
.XX) *
Status200OKXX* 5
,XX5 6
newXX7 :
{XX; <
dataXX= A
=XXB C
objetoXXD J
}XXK L
)XXL M
;XXM N
}YY 	
[[[ 	
	Authorize[[	 
([[ !
AuthenticationSchemes[[ (
=[[) *
JwtBearerDefaults[[+ <
.[[< = 
AuthenticationScheme[[= Q
)[[Q R
][[R S
[\\ 	
HttpGet\\	 
]\\ 
[]] 	
	Authorize]]	 
(]] 
Roles]] 
=]] 
$str]] 3
)]]3 4
]]]4 5
public^^ 
async^^ 
Task^^ 
<^^ 
IActionResult^^ '
>^^' (
ObtenerPrestamos2^^) :
(^^: ;
int^^; >

IdPrestamo^^? I
,^^I J
string^^K Q
NroDocumento^^R ^
)^^^ _
{__ 	
List`` 
<`` 
Prestamo`` 
.`` 
	Entidades`` #
.``# $
Prestamo``$ ,
>``, -
objeto``. 4
=``5 6
await``7 <
_prestamoData``= J
.``J K
ObtenerPrestamos2``K \
(``\ ]

IdPrestamo``] g
,``g h
NroDocumento``i u
==``v x
null``y }
?``~ 
$str
`` 
:
`` 
NroDocumento
`` 
)
`` 
;
`` 
returnaa 

StatusCodeaa 
(aa 
StatusCodesaa )
.aa) *
Status200OKaa* 5
,aa5 6
newaa7 :
{aa; <
dataaa= A
=aaB C
objetoaaD J
}aaK L
)aaL M
;aaM N
}bb 	
[dd 	
	Authorizedd	 
(dd !
AuthenticationSchemesdd (
=dd) *
JwtBearerDefaultsdd+ <
.dd< = 
AuthenticationSchemedd= Q
)ddQ R
]ddR S
[ee 	
HttpGetee	 
]ee 
[ff 	
	Authorizeff	 
(ff 
Rolesff 
=ff 
$strff *
)ff* +
]ff+ ,
publicgg 
asyncgg 
Taskgg 
<gg 
IActionResultgg '
>gg' (
ImprimirPrestamogg) 9
(gg9 :
intgg: =

IdPrestamogg> H
)ggH I
{hh 	
ifii 
(ii 
!ii 

ModelStateii 
.ii 
IsValidii #
)ii# $
{jj 
returnkk 

BadRequestkk !
(kk! "

ModelStatekk" ,
)kk, -
;kk- .
}ll 
Listmm 
<mm 
Prestamomm 
.mm 
	Entidadesmm #
.mm# $
Prestamomm$ ,
>mm, -
listamm. 3
=mm4 5
awaitmm6 ;
_prestamoDatamm< I
.mmI J
ObtenerPrestamosmmJ Z
(mmZ [

IdPrestamomm[ e
,mme f
$strmmg i
)mmi j
;mmj k
Prestamonn 
.nn 
	Entidadesnn 
.nn 
Prestamonn '
objetonn( .
=nn/ 0
listann1 6
[nn6 7
$numnn7 8
]nn8 9
;nn9 :
QuestPDFpp 
.pp 
Settingspp 
.pp 
Licensepp %
=pp& '
QuestPDFpp( 0
.pp0 1
Infrastructurepp1 ?
.pp? @
LicenseTypepp@ K
.ppK L
	CommunityppL U
;ppU V
varqq 
pdfqq 
=qq 
Documentqq 
.qq 
Createqq %
(qq% &
documentqq& .
=>qq/ 1
{rr 
documentss 
.ss 
Pagess 
(ss 
pagess "
=>ss# %
{tt 
pagevv 
.vv 
Marginvv 
(vv  
$numvv  "
)vv" #
;vv# $
pagexx 
.xx 
Headerxx 
(xx  
)xx  !
.xx! "
ShowOncexx" *
(xx* +
)xx+ ,
.xx, -

Backgroundxx- 7
(xx7 8
$strxx8 A
)xxA B
.xxB C
PaddingxxC J
(xxJ K
$numxxK L
)xxL M
.xxM N
RowxxN Q
(xxQ R
rowxxR U
=>xxV X
{yy 
rowzz 
.zz 
RelativeItemzz (
(zz( )
)zz) *
.zz* +
	AlignLeftzz+ 4
(zz4 5
)zz5 6
.zz6 7
Textzz7 ;
(zz; <
$strzz< F
)zzF G
.zzG H
BoldzzH L
(zzL M
)zzM N
.zzN O
FontSizezzO W
(zzW X
$numzzX Z
)zzZ [
;zz[ \
row{{ 
.{{ 
RelativeItem{{ (
({{( )
){{) *
.{{* +

AlignRight{{+ 5
({{5 6
){{6 7
.{{7 8
Text{{8 <
({{< =
$"{{= ?
$str{{? D
{{{D E
objeto{{E K
.{{K L

IdPrestamo{{L V
}{{V W
"{{W X
){{X Y
.{{Y Z
Bold{{Z ^
({{^ _
){{_ `
.{{` a
FontSize{{a i
({{i j
$num{{j l
){{l m
;{{m n
}|| 
)|| 
;|| 
page~~ 
.~~ 
Content~~  
(~~  !
)~~! "
.~~" #
PaddingVertical~~# 2
(~~2 3
$num~~3 5
)~~5 6
.~~6 7
Column~~7 =
(~~= >
col1~~> B
=>~~C E
{ 
col1
 
.
 
Spacing
 $
(
$ %
$num
% '
)
' (
;
( )
col1
 
.
 
Item
 !
(
! "
)
" #
.
# $
Column
$ *
(
* +
col2
+ /
=>
0 2
{
 
col2
  
.
  !
Spacing
! (
(
( )
$num
) *
)
* +
;
+ ,
col2
  
.
  !
Item
! %
(
% &
)
& '
.
' (
Row
( +
(
+ ,
row
, /
=>
0 2
{
 
row
  #
.
# $
RelativeItem
$ 0
(
0 1
)
1 2
.
2 3
BorderBottom
3 ?
(
? @
$num
@ A
)
A B
.
B C
	AlignLeft
C L
(
L M
)
M N
.
N O
Text
O S
(
S T
$str
T g
)
g h
.
h i
Bold
i m
(
m n
)
n o
.
o p
FontSize
p x
(
x y
$num
y {
)
{ |
;
| }
}
 
)
 
;
 
col2
  
.
  !
Item
! %
(
% &
)
& '
.
' (
Row
( +
(
+ ,
row
, /
=>
0 2
{
 
row
  #
.
# $
RelativeItem
$ 0
(
0 1
)
1 2
.
2 3
Column
3 9
(
9 :
col
: =
=>
> @
{
  !
col
$ '
.
' (
Item
( ,
(
, -
)
- .
.
. /
Text
/ 3
(
3 4
txt
4 7
=>
8 :
{
$ %
txt
( +
.
+ ,
Span
, 0
(
0 1
$str
1 E
)
E F
.
F G
SemiBold
G O
(
O P
)
P Q
.
Q R
FontSize
R Z
(
Z [
$num
[ ]
)
] ^
;
^ _
txt
( +
.
+ ,
Span
, 0
(
0 1
objeto
1 7
.
7 8
Cliente
8 ?
.
? @
NroDocumento
@ L
)
L M
.
M N
FontSize
N V
(
V W
$num
W Y
)
Y Z
;
Z [
}
$ %
)
% &
;
& '
col
$ '
.
' (
Item
( ,
(
, -
)
- .
.
. /
Text
/ 3
(
3 4
txt
4 7
=>
8 :
{
$ %
txt
( +
.
+ ,
Span
, 0
(
0 1
$str
1 ;
)
; <
.
< =
SemiBold
= E
(
E F
)
F G
.
G H
FontSize
H P
(
P Q
$num
Q S
)
S T
;
T U
txt
( +
.
+ ,
Span
, 0
(
0 1
objeto
1 7
.
7 8
Cliente
8 ?
.
? @
Nombre
@ F
)
F G
.
G H
FontSize
H P
(
P Q
$num
Q S
)
S T
;
T U
}
$ %
)
% &
;
& '
col
$ '
.
' (
Item
( ,
(
, -
)
- .
.
. /
Text
/ 3
(
3 4
txt
4 7
=>
8 :
{
$ %
txt
( +
.
+ ,
Span
, 0
(
0 1
$str
1 =
)
= >
.
> ?
SemiBold
? G
(
G H
)
H I
.
I J
FontSize
J R
(
R S
$num
S U
)
U V
;
V W
txt
( +
.
+ ,
Span
, 0
(
0 1
objeto
1 7
.
7 8
Cliente
8 ?
.
? @
Apellido
@ H
)
H I
.
I J
FontSize
J R
(
R S
$num
S U
)
U V
;
V W
}
$ %
)
% &
;
& '
}
  !
)
! "
;
" #
row
  #
.
# $
ConstantItem
$ 0
(
0 1
$num
1 3
)
3 4
;
4 5
row
  #
.
# $
RelativeItem
$ 0
(
0 1
)
1 2
.
2 3
Column
3 9
(
9 :
col
: =
=>
> @
{
    !
col
¡¡$ '
.
¡¡' (
Item
¡¡( ,
(
¡¡, -
)
¡¡- .
.
¡¡. /
Text
¡¡/ 3
(
¡¡3 4
txt
¡¡4 7
=>
¡¡8 :
{
¢¢$ %
txt
££( +
.
££+ ,
Span
££, 0
(
££0 1
$str
££1 ;
)
££; <
.
££< =
SemiBold
££= E
(
££E F
)
££F G
.
££G H
FontSize
££H P
(
££P Q
$num
££Q S
)
££S T
;
££T U
txt
¤¤( +
.
¤¤+ ,
Span
¤¤, 0
(
¤¤0 1
objeto
¤¤1 7
.
¤¤7 8
Cliente
¤¤8 ?
.
¤¤? @
Correo
¤¤@ F
)
¤¤F G
.
¤¤G H
FontSize
¤¤H P
(
¤¤P Q
$num
¤¤Q S
)
¤¤S T
;
¤¤T U
}
¥¥$ %
)
¥¥% &
;
¥¥& '
col
¦¦$ '
.
¦¦' (
Item
¦¦( ,
(
¦¦, -
)
¦¦- .
.
¦¦. /
Text
¦¦/ 3
(
¦¦3 4
txt
¦¦4 7
=>
¦¦8 :
{
§§$ %
txt
¨¨( +
.
¨¨+ ,
Span
¨¨, 0
(
¨¨0 1
$str
¨¨1 =
)
¨¨= >
.
¨¨> ?
SemiBold
¨¨? G
(
¨¨G H
)
¨¨H I
.
¨¨I J
FontSize
¨¨J R
(
¨¨R S
$num
¨¨S U
)
¨¨U V
;
¨¨V W
txt
©©( +
.
©©+ ,
Span
©©, 0
(
©©0 1
objeto
©©1 7
.
©©7 8
Cliente
©©8 ?
.
©©? @
Telefono
©©@ H
)
©©H I
.
©©I J
FontSize
©©J R
(
©©R S
$num
©©S U
)
©©U V
;
©©V W
}
ªª$ %
)
ªª% &
;
ªª& '
}
««  !
)
««! "
;
««" #
}
¬¬ 
)
¬¬ 
;
¬¬ 
}
­­ 
)
­­ 
;
­­ 
col1
¯¯ 
.
¯¯ 
Item
¯¯ !
(
¯¯! "
)
¯¯" #
.
¯¯# $
Column
¯¯$ *
(
¯¯* +
col2
¯¯+ /
=>
¯¯0 2
{
°° 
col2
±±  
.
±±  !
Spacing
±±! (
(
±±( )
$num
±±) *
)
±±* +
;
±±+ ,
col2
²²  
.
²²  !
Item
²²! %
(
²²% &
)
²²& '
.
²²' (
Row
²²( +
(
²²+ ,
row
²², /
=>
²²0 2
{
³³ 
row
´´  #
.
´´# $
RelativeItem
´´$ 0
(
´´0 1
)
´´1 2
.
´´2 3
BorderBottom
´´3 ?
(
´´? @
$num
´´@ A
)
´´A B
.
´´B C
	AlignLeft
´´C L
(
´´L M
)
´´M N
.
´´N O
Text
´´O S
(
´´S T
$str
´´T h
)
´´h i
.
´´i j
Bold
´´j n
(
´´n o
)
´´o p
.
´´p q
FontSize
´´q y
(
´´y z
$num
´´z |
)
´´| }
;
´´} ~
}
µµ 
)
µµ 
;
µµ 
col2
··  
.
··  !
Item
··! %
(
··% &
)
··& '
.
··' (
Row
··( +
(
··+ ,
row
··, /
=>
··0 2
{
¸¸ 
row
¹¹  #
.
¹¹# $
RelativeItem
¹¹$ 0
(
¹¹0 1
)
¹¹1 2
.
¹¹2 3
Column
¹¹3 9
(
¹¹9 :
col
¹¹: =
=>
¹¹> @
{
ºº  !
col
»»$ '
.
»»' (
Item
»»( ,
(
»», -
)
»»- .
.
»». /
Text
»»/ 3
(
»»3 4
txt
»»4 7
=>
»»8 :
{
¼¼$ %
txt
½½( +
.
½½+ ,
Span
½½, 0
(
½½0 1
$str
½½1 C
)
½½C D
.
½½D E
SemiBold
½½E M
(
½½M N
)
½½N O
.
½½O P
FontSize
½½P X
(
½½X Y
$num
½½Y [
)
½½[ \
;
½½\ ]
txt
¾¾( +
.
¾¾+ ,
Span
¾¾, 0
(
¾¾0 1
objeto
¾¾1 7
.
¾¾7 8
MontoPrestamo
¾¾8 E
)
¾¾E F
.
¾¾F G
FontSize
¾¾G O
(
¾¾O P
$num
¾¾P R
)
¾¾R S
;
¾¾S T
}
¿¿$ %
)
¿¿% &
;
¿¿& '
col
ÀÀ$ '
.
ÀÀ' (
Item
ÀÀ( ,
(
ÀÀ, -
)
ÀÀ- .
.
ÀÀ. /
Text
ÀÀ/ 3
(
ÀÀ3 4
txt
ÀÀ4 7
=>
ÀÀ8 :
{
ÁÁ$ %
txt
ÂÂ( +
.
ÂÂ+ ,
Span
ÂÂ, 0
(
ÂÂ0 1
$str
ÂÂ1 >
)
ÂÂ> ?
.
ÂÂ? @
SemiBold
ÂÂ@ H
(
ÂÂH I
)
ÂÂI J
.
ÂÂJ K
FontSize
ÂÂK S
(
ÂÂS T
$num
ÂÂT V
)
ÂÂV W
;
ÂÂW X
txt
ÃÃ( +
.
ÃÃ+ ,
Span
ÃÃ, 0
(
ÃÃ0 1
objeto
ÃÃ1 7
.
ÃÃ7 8
InteresPorcentaje
ÃÃ8 I
)
ÃÃI J
.
ÃÃJ K
FontSize
ÃÃK S
(
ÃÃS T
$num
ÃÃT V
)
ÃÃV W
;
ÃÃW X
}
ÄÄ$ %
)
ÄÄ% &
;
ÄÄ& '
col
ÅÅ$ '
.
ÅÅ' (
Item
ÅÅ( ,
(
ÅÅ, -
)
ÅÅ- .
.
ÅÅ. /
Text
ÅÅ/ 3
(
ÅÅ3 4
txt
ÅÅ4 7
=>
ÅÅ8 :
{
ÆÆ$ %
txt
ÇÇ( +
.
ÇÇ+ ,
Span
ÇÇ, 0
(
ÇÇ0 1
$str
ÇÇ1 B
)
ÇÇB C
.
ÇÇC D
SemiBold
ÇÇD L
(
ÇÇL M
)
ÇÇM N
.
ÇÇN O
FontSize
ÇÇO W
(
ÇÇW X
$num
ÇÇX Z
)
ÇÇZ [
;
ÇÇ[ \
txt
ÈÈ( +
.
ÈÈ+ ,
Span
ÈÈ, 0
(
ÈÈ0 1
objeto
ÈÈ1 7
.
ÈÈ7 8
	NroCuotas
ÈÈ8 A
.
ÈÈA B
ToString
ÈÈB J
(
ÈÈJ K
)
ÈÈK L
)
ÈÈL M
.
ÈÈM N
FontSize
ÈÈN V
(
ÈÈV W
$num
ÈÈW Y
)
ÈÈY Z
;
ÈÈZ [
}
ÉÉ$ %
)
ÉÉ% &
;
ÉÉ& '
col
ÊÊ$ '
.
ÊÊ' (
Item
ÊÊ( ,
(
ÊÊ, -
)
ÊÊ- .
.
ÊÊ. /
Text
ÊÊ/ 3
(
ÊÊ3 4
txt
ÊÊ4 7
=>
ÊÊ8 :
{
ËË$ %
txt
ÌÌ( +
.
ÌÌ+ ,
Span
ÌÌ, 0
(
ÌÌ0 1
$str
ÌÌ1 B
)
ÌÌB C
.
ÌÌC D
SemiBold
ÌÌD L
(
ÌÌL M
)
ÌÌM N
.
ÌÌN O
FontSize
ÌÌO W
(
ÌÌW X
$num
ÌÌX Z
)
ÌÌZ [
;
ÌÌ[ \
txt
ÍÍ( +
.
ÍÍ+ ,
Span
ÍÍ, 0
(
ÍÍ0 1
objeto
ÍÍ1 7
.
ÍÍ7 8
FormaDePago
ÍÍ8 C
)
ÍÍC D
.
ÍÍD E
FontSize
ÍÍE M
(
ÍÍM N
$num
ÍÍN P
)
ÍÍP Q
;
ÍÍQ R
}
ÎÎ$ %
)
ÎÎ% &
;
ÎÎ& '
col
ÏÏ$ '
.
ÏÏ' (
Item
ÏÏ( ,
(
ÏÏ, -
)
ÏÏ- .
.
ÏÏ. /
Text
ÏÏ/ 3
(
ÏÏ3 4
txt
ÏÏ4 7
=>
ÏÏ8 :
{
ÐÐ$ %
txt
ÑÑ( +
.
ÑÑ+ ,
Span
ÑÑ, 0
(
ÑÑ0 1
$str
ÑÑ1 @
)
ÑÑ@ A
.
ÑÑA B
SemiBold
ÑÑB J
(
ÑÑJ K
)
ÑÑK L
.
ÑÑL M
FontSize
ÑÑM U
(
ÑÑU V
$num
ÑÑV X
)
ÑÑX Y
;
ÑÑY Z
txt
ÒÒ( +
.
ÒÒ+ ,
Span
ÒÒ, 0
(
ÒÒ0 1
objeto
ÒÒ1 7
.
ÒÒ7 8
Moneda
ÒÒ8 >
.
ÒÒ> ?
Nombre
ÒÒ? E
)
ÒÒE F
.
ÒÒF G
FontSize
ÒÒG O
(
ÒÒO P
$num
ÒÒP R
)
ÒÒR S
;
ÒÒS T
}
ÓÓ$ %
)
ÓÓ% &
;
ÓÓ& '
}
ÔÔ  !
)
ÔÔ! "
;
ÔÔ" #
row
ÕÕ  #
.
ÕÕ# $
ConstantItem
ÕÕ$ 0
(
ÕÕ0 1
$num
ÕÕ1 3
)
ÕÕ3 4
;
ÕÕ4 5
row
ÖÖ  #
.
ÖÖ# $
RelativeItem
ÖÖ$ 0
(
ÖÖ0 1
)
ÖÖ1 2
.
ÖÖ2 3
Column
ÖÖ3 9
(
ÖÖ9 :
col
ÖÖ: =
=>
ÖÖ> @
{
××  !
col
ØØ$ '
.
ØØ' (
Item
ØØ( ,
(
ØØ, -
)
ØØ- .
.
ØØ. /
Text
ØØ/ 3
(
ØØ3 4
txt
ØØ4 7
=>
ØØ8 :
{
ÙÙ$ %
txt
ÚÚ( +
.
ÚÚ+ ,
Span
ÚÚ, 0
(
ÚÚ0 1
$str
ÚÚ1 D
)
ÚÚD E
.
ÚÚE F
SemiBold
ÚÚF N
(
ÚÚN O
)
ÚÚO P
.
ÚÚP Q
FontSize
ÚÚQ Y
(
ÚÚY Z
$num
ÚÚZ \
)
ÚÚ\ ]
;
ÚÚ] ^
txt
ÛÛ( +
.
ÛÛ+ ,
Span
ÛÛ, 0
(
ÛÛ0 1
objeto
ÛÛ1 7
.
ÛÛ7 8
ValorPorCuota
ÛÛ8 E
)
ÛÛE F
.
ÛÛF G
FontSize
ÛÛG O
(
ÛÛO P
$num
ÛÛP R
)
ÛÛR S
;
ÛÛS T
}
ÜÜ$ %
)
ÜÜ% &
;
ÜÜ& '
col
ÝÝ$ '
.
ÝÝ' (
Item
ÝÝ( ,
(
ÝÝ, -
)
ÝÝ- .
.
ÝÝ. /
Text
ÝÝ/ 3
(
ÝÝ3 4
txt
ÝÝ4 7
=>
ÝÝ8 :
{
ÞÞ$ %
txt
ßß( +
.
ßß+ ,
Span
ßß, 0
(
ßß0 1
$str
ßß1 B
)
ßßB C
.
ßßC D
SemiBold
ßßD L
(
ßßL M
)
ßßM N
.
ßßN O
FontSize
ßßO W
(
ßßW X
$num
ßßX Z
)
ßßZ [
;
ßß[ \
txt
àà( +
.
àà+ ,
Span
àà, 0
(
àà0 1
objeto
àà1 7
.
àà7 8
ValorInteres
àà8 D
)
ààD E
.
ààE F
FontSize
ààF N
(
ààN O
$num
ààO Q
)
ààQ R
;
ààR S
}
áá$ %
)
áá% &
;
áá& '
col
ââ$ '
.
ââ' (
Item
ââ( ,
(
ââ, -
)
ââ- .
.
ââ. /
Text
ââ/ 3
(
ââ3 4
txt
ââ4 7
=>
ââ8 :
{
ãã$ %
txt
ää( +
.
ää+ ,
Span
ää, 0
(
ää0 1
$str
ää1 @
)
ää@ A
.
ääA B
SemiBold
ääB J
(
ääJ K
)
ääK L
.
ääL M
FontSize
ääM U
(
ääU V
$num
ääV X
)
ääX Y
;
ääY Z
txt
åå( +
.
åå+ ,
Span
åå, 0
(
åå0 1
objeto
åå1 7
.
åå7 8

ValorTotal
åå8 B
)
ååB C
.
ååC D
FontSize
ååD L
(
ååL M
$num
ååM O
)
ååO P
;
ååP Q
}
ææ$ %
)
ææ% &
;
ææ& '
}
çç  !
)
çç! "
;
çç" #
}
èè 
)
èè 
;
èè 
}
éé 
)
éé 
;
éé 
col1
ìì 
.
ìì 
Item
ìì !
(
ìì! "
)
ìì" #
.
ìì# $
Column
ìì$ *
(
ìì* +
col2
ìì+ /
=>
ìì0 2
{
íí 
col2
îî  
.
îî  !
Spacing
îî! (
(
îî( )
$num
îî) *
)
îî* +
;
îî+ ,
col2
ïï  
.
ïï  !
Item
ïï! %
(
ïï% &
)
ïï& '
.
ïï' (
Row
ïï( +
(
ïï+ ,
row
ïï, /
=>
ïï0 2
{
ðð 
row
ññ  #
.
ññ# $
RelativeItem
ññ$ 0
(
ññ0 1
)
ññ1 2
.
ññ2 3
BorderBottom
ññ3 ?
(
ññ? @
$num
ññ@ A
)
ññA B
.
ññB C
	AlignLeft
ññC L
(
ññL M
)
ññM N
.
ññN O
Text
ññO S
(
ññS T
$str
ññT d
)
ññd e
.
ññe f
Bold
ññf j
(
ññj k
)
ññk l
.
ññl m
FontSize
ññm u
(
ññu v
$num
ññv x
)
ññx y
;
ññy z
}
òò 
)
òò 
;
òò 
col2
óó  
.
óó  !
Item
óó! %
(
óó% &
)
óó& '
.
óó' (
Table
óó( -
(
óó- .
tabla
óó. 3
=>
óó4 6
{
ôô 
tabla
õõ  %
.
õõ% &
ColumnsDefinition
õõ& 7
(
õõ7 8
columns
õõ8 ?
=>
õõ@ B
{
öö  !
columns
÷÷$ +
.
÷÷+ ,
RelativeColumn
÷÷, :
(
÷÷: ;
$num
÷÷; <
)
÷÷< =
;
÷÷= >
columns
øø$ +
.
øø+ ,
RelativeColumn
øø, :
(
øø: ;
)
øø; <
;
øø< =
columns
ùù$ +
.
ùù+ ,
RelativeColumn
ùù, :
(
ùù: ;
)
ùù; <
;
ùù< =
columns
úú$ +
.
úú+ ,
RelativeColumn
úú, :
(
úú: ;
)
úú; <
;
úú< =
}
üü  !
)
üü! "
;
üü" #
tabla
þþ  %
.
þþ% &
Header
þþ& ,
(
þþ, -
header
þþ- 3
=>
þþ4 6
{
ÿÿ  !
header
$ *
.
* +
Cell
+ /
(
/ 0
)
0 1
.
1 2

Background
2 <
(
< =
$str
= F
)
F G
.
$ %
Padding
% ,
(
, -
$num
- .
)
. /
.
/ 0
Text
0 4
(
4 5
$str
5 A
)
A B
.
B C
	FontColor
C L
(
L M
$str
M S
)
S T
;
T U
header
$ *
.
* +
Cell
+ /
(
/ 0
)
0 1
.
1 2

Background
2 <
(
< =
$str
= F
)
F G
.
# $
Padding
$ +
(
+ ,
$num
, -
)
- .
.
. /
Text
/ 3
(
3 4
$str
4 C
)
C D
.
D E
	FontColor
E N
(
N O
$str
O U
)
U V
;
V W
header
$ *
.
* +
Cell
+ /
(
/ 0
)
0 1
.
1 2

Background
2 <
(
< =
$str
= F
)
F G
.
# $
Padding
$ +
(
+ ,
$num
, -
)
- .
.
. /
Text
/ 3
(
3 4
$str
4 C
)
C D
.
D E
	FontColor
E N
(
N O
$str
O U
)
U V
;
V W
header
$ *
.
* +
Cell
+ /
(
/ 0
)
0 1
.
1 2

Background
2 <
(
< =
$str
= F
)
F G
.
# $
Padding
$ +
(
+ ,
$num
, -
)
- .
.
. /
Text
/ 3
(
3 4
$str
4 <
)
< =
.
= >
	FontColor
> G
(
G H
$str
H N
)
N O
;
O P
}
  !
)
! "
;
" #
foreach
  '
(
( )
var
) ,
item
- 1
in
2 4
objeto
5 ;
.
; <
PrestamoDetalle
< K
)
K L
{
  !
tabla
$ )
.
) *
Cell
* .
(
. /
)
/ 0
.
0 1
Border
1 7
(
7 8
$num
8 <
)
< =
.
= >
BorderColor
> I
(
I J
$str
J S
)
S T
.
( )
Padding
) 0
(
0 1
$num
1 2
)
2 3
.
3 4
Text
4 8
(
8 9
item
9 =
.
= >
NroCuota
> F
.
F G
ToString
G O
(
O P
)
P Q
)
Q R
.
R S
FontSize
S [
(
[ \
$num
\ ^
)
^ _
;
_ `
tabla
$ )
.
) *
Cell
* .
(
. /
)
/ 0
.
0 1
Border
1 7
(
7 8
$num
8 <
)
< =
.
= >
BorderColor
> I
(
I J
$str
J S
)
S T
.
% &
Padding
& -
(
- .
$num
. /
)
/ 0
.
0 1
Text
1 5
(
5 6
item
6 :
.
: ;
	FechaPago
; D
)
D E
.
E F
FontSize
F N
(
N O
$num
O Q
)
Q R
;
R S
tabla
$ )
.
) *
Cell
* .
(
. /
)
/ 0
.
0 1
Border
1 7
(
7 8
$num
8 <
)
< =
.
= >
BorderColor
> I
(
I J
$str
J S
)
S T
.
% &
Padding
& -
(
- .
$num
. /
)
/ 0
.
0 1
Text
1 5
(
5 6
$"
6 8
{
8 9
objeto
9 ?
.
? @
Moneda
@ F
.
F G
Simbolo
G N
}
N O
$str
O P
{
P Q
item
Q U
.
U V

MontoCuota
V `
}
` a
"
a b
)
b c
.
c d
FontSize
d l
(
l m
$num
m o
)
o p
;
p q
tabla
$ )
.
) *
Cell
* .
(
. /
)
/ 0
.
0 1
Border
1 7
(
7 8
$num
8 <
)
< =
.
= >
BorderColor
> I
(
I J
$str
J S
)
S T
.
% &
Padding
& -
(
- .
$num
. /
)
/ 0
.
0 1

AlignRight
1 ;
(
; <
)
< =
.
= >
Text
> B
(
B C
$"
C E
{
E F
item
F J
.
J K
Estado
K Q
}
Q R
"
R S
)
S T
.
T U
FontSize
U ]
(
] ^
$num
^ `
)
` a
;
a b
}
  !
}
 
)
 
;
 
}
 
)
 
;
 
}
¡¡ 
)
¡¡ 
;
¡¡ 
page
¤¤ 
.
¤¤ 
Footer
¤¤ 
(
¤¤  
)
¤¤  !
.
¥¥ 

AlignRight
¥¥ 
(
¥¥  
)
¥¥  !
.
¦¦ 
Text
¦¦ 
(
¦¦ 
txt
¦¦ 
=>
¦¦  
{
§§ 
txt
¨¨ 
.
¨¨ 
Span
¨¨  
(
¨¨  !
$str
¨¨! *
)
¨¨* +
.
¨¨+ ,
FontSize
¨¨, 4
(
¨¨4 5
$num
¨¨5 7
)
¨¨7 8
;
¨¨8 9
txt
©© 
.
©© 
CurrentPageNumber
©© -
(
©©- .
)
©©. /
.
©©/ 0
FontSize
©©0 8
(
©©8 9
$num
©©9 ;
)
©©; <
;
©©< =
txt
ªª 
.
ªª 
Span
ªª  
(
ªª  !
$str
ªª! '
)
ªª' (
.
ªª( )
FontSize
ªª) 1
(
ªª1 2
$num
ªª2 4
)
ªª4 5
;
ªª5 6
txt
«« 
.
«« 

TotalPages
«« &
(
««& '
)
««' (
.
««( )
FontSize
««) 1
(
««1 2
$num
««2 4
)
««4 5
;
««5 6
}
¬¬ 
)
¬¬ 
;
¬¬ 
}
­­ 
)
­­ 
;
­­ 
}
®® 
)
®® 
.
®® 
GeneratePdf
®® 
(
®® 
)
®® 
;
®® 
Stream
±± 
	pdfStream
±± 
=
±± 
new
±± "
MemoryStream
±±# /
(
±±/ 0
pdf
±±0 3
)
±±3 4
;
±±4 5
return
²² 
File
²² 
(
²² 
	pdfStream
²² !
,
²²! "
$str
²²# 4
)
²²4 5
;
²²5 6
}
³³ 	
}
´´ 
}µµ ø>
gC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\MonedaController.cs
	namespace		 	
Prestamo		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
	Authorize 
] 
public 

class 
MonedaController !
:" #

Controller$ .
{ 
private 
readonly 

MonedaData #
_monedaData$ /
;/ 0
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
MonedaController 
(  

MonedaData  *

monedaData+ 5
,5 6
AuditoriaService7 G
auditoriaServiceH X
)X Y
{ 	
_monedaData 
= 

monedaData $
;$ %
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
[ 	
	Authorize	 
( !
AuthenticationSchemes (
=) *
JwtBearerDefaults+ <
.< = 
AuthenticationScheme= Q
)Q R
]R S
[ 	
HttpGet	 
] 
[ 	
	Authorize	 
( 
Roles 
= 
$str *
)* +
]+ ,
public 
async 
Task 
< 
IActionResult '
>' (
Lista) .
(. /
)/ 0
{   	
List!! 
<!! 
Moneda!! 
>!! 
lista!! 
=!!  
await!!! &
_monedaData!!' 2
.!!2 3
Lista!!3 8
(!!8 9
)!!9 :
;!!: ;
await"" 
_auditoriaService"" #
.""# $
RegistrarLog""$ 0
(""0 1
User""1 5
.""5 6
Identity""6 >
.""> ?
Name""? C
,""C D
$str""E L
,""L M
$str""N x
)""x y
;""y z
return## 

StatusCode## 
(## 
StatusCodes## )
.##) *
Status200OK##* 5
,##5 6
new##7 :
{##; <
data##= A
=##B C
lista##D I
}##J K
)##K L
;##L M
}$$ 	
[&& 	
	Authorize&&	 
(&& !
AuthenticationSchemes&& (
=&&) *
JwtBearerDefaults&&+ <
.&&< = 
AuthenticationScheme&&= Q
)&&Q R
]&&R S
['' 	
HttpPost''	 
]'' 
[(( 	
	Authorize((	 
((( 
Roles(( 
=(( 
$str(( *
)((* +
]((+ ,
public)) 
async)) 
Task)) 
<)) 
IActionResult)) '
>))' (
Crear))) .
()). /
[))/ 0
FromBody))0 8
]))8 9
Moneda)): @
objeto))A G
)))G H
{** 	
if++ 
(++ 
!++ 

ModelState++ 
.++ 
IsValid++ #
)++# $
{,, 
return-- 

BadRequest-- !
(--! "

ModelState--" ,
)--, -
;--- .
}.. 
string// 
	respuesta// 
=// 
await// $
_monedaData//% 0
.//0 1
Crear//1 6
(//6 7
objeto//7 =
)//= >
;//> ?
await00 
_auditoriaService00 #
.00# $
RegistrarLog00$ 0
(000 1
User001 5
.005 6
Identity006 >
.00> ?
Name00? C
,00C D
$str00E L
,00L M
$"00N P
$str00P _
{00_ `
objeto00` f
.00f g
Nombre00g m
}00m n
"00n o
)00o p
;00p q
return11 

StatusCode11 
(11 
StatusCodes11 )
.11) *
Status200OK11* 5
,115 6
new117 :
{11; <
data11= A
=11B C
	respuesta11D M
}11N O
)11O P
;11P Q
}22 	
[44 	
	Authorize44	 
(44 !
AuthenticationSchemes44 (
=44) *
JwtBearerDefaults44+ <
.44< = 
AuthenticationScheme44= Q
)44Q R
]44R S
[55 	
HttpPut55	 
]55 
[66 	
	Authorize66	 
(66 
Roles66 
=66 
$str66 *
)66* +
]66+ ,
public77 
async77 
Task77 
<77 
IActionResult77 '
>77' (
Editar77) /
(77/ 0
[770 1
FromBody771 9
]779 :
Moneda77; A
objeto77B H
)77H I
{88 	
if99 
(99 
!99 

ModelState99 
.99 
IsValid99 #
)99# $
{:: 
return;; 

BadRequest;; !
(;;! "

ModelState;;" ,
);;, -
;;;- .
}<< 
string== 
	respuesta== 
=== 
await== $
_monedaData==% 0
.==0 1
Editar==1 7
(==7 8
objeto==8 >
)==> ?
;==? @
await>> 
_auditoriaService>> #
.>># $
RegistrarLog>>$ 0
(>>0 1
User>>1 5
.>>5 6
Identity>>6 >
.>>> ?
Name>>? C
!>>C D
,>>D E
$str>>F N
,>>N O
$">>P R
$str>>R b
{>>b c
objeto>>c i
.>>i j
Nombre>>j p
}>>p q
">>q r
)>>r s
;>>s t
return?? 

StatusCode?? 
(?? 
StatusCodes?? )
.??) *
Status200OK??* 5
,??5 6
new??7 :
{??; <
data??= A
=??B C
	respuesta??D M
}??N O
)??O P
;??P Q
}@@ 	
[BB 	
	AuthorizeBB	 
(BB !
AuthenticationSchemesBB (
=BB) *
JwtBearerDefaultsBB+ <
.BB< = 
AuthenticationSchemeBB= Q
)BBQ R
]BBR S
[CC 	

HttpDeleteCC	 
]CC 
[DD 	
	AuthorizeDD	 
(DD 
RolesDD 
=DD 
$strDD *
)DD* +
]DD+ ,
publicEE 
asyncEE 
TaskEE 
<EE 
IActionResultEE '
>EE' (
EliminarEE) 1
(EE1 2
intEE2 5
IdEE6 8
)EE8 9
{FF 	
ifGG 
(GG 
!GG 

ModelStateGG 
.GG 
IsValidGG #
)GG# $
{HH 
returnII 

BadRequestII !
(II! "

ModelStateII" ,
)II, -
;II- .
}JJ 
stringKK 
	respuestaKK 
=KK 
awaitKK $
_monedaDataKK% 0
.KK0 1
EliminarKK1 9
(KK9 :
IdKK: <
)KK< =
;KK= >
awaitLL 
_auditoriaServiceLL #
.LL# $
RegistrarLogLL$ 0
(LL0 1
UserLL1 5
.LL5 6
IdentityLL6 >
.LL> ?
NameLL? C
,LLC D
$strLLE O
,LLO P
$"LLQ S
$strLLS l
{LLl m
IdLLm o
}LLo p
"LLp q
)LLq r
;LLr s
returnMM 

StatusCodeMM 
(MM 
StatusCodesMM )
.MM) *
Status200OKMM* 5
,MM5 6
newMM7 :
{MM; <
dataMM= A
=MMB C
	respuestaMMD M
}MMN O
)MMO P
;MMP Q
}NN 	
}OO 
}PP åª
fC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\LoginController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
public 

class 
LoginController  
:! "

Controller# -
{ 
private 
readonly 
UsuarioData $
_usuarioData% 1
;1 2
private 
readonly 
EmailService %
_emailService& 3
;3 4
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
LoginController 
( 
UsuarioData *
usuarioData+ 6
,6 7
EmailService8 D
emailServiceE Q
,Q R
IConfigurationS a
configurationb o
,o p
AuditoriaService	q 
auditoriaService
 
)
 
{ 	
_usuarioData 
= 
usuarioData &
;& '
_emailService 
= 
emailService (
;( )
_configuration   
=   
configuration   *
;  * +
_auditoriaService!! 
=!! 
auditoriaService!!  0
;!!0 1
}"" 	
public## 
IActionResult## 
Index## "
(##" #
)### $
{$$ 	
return%% 
View%% 
(%% 
)%% 
;%% 
}&& 	
[(( 	
HttpPost((	 
](( 
public)) 
async)) 
Task)) 
<)) 
IActionResult)) '
>))' (
Index))) .
()). /
string))/ 5
correo))6 <
,))< =
string))> D
clave))E J
)))J K
{** 	
if++ 
(++ 
string++ 
.++ 
IsNullOrEmpty++ $
(++$ %
correo++% +
)+++ ,
||++- /
string++0 6
.++6 7
IsNullOrEmpty++7 D
(++D E
clave++E J
)++J K
)++K L
{,, 
ViewData-- 
[-- 
$str-- "
]--" #
=--$ %
$str--& I
;--I J
return.. 
View.. 
(.. 
).. 
;.. 
}// 
var22 
usuario22 
=22 
await22 
_usuarioData22  ,
.22, -
ObtenerPorCorreo22- =
(22= >
correo22> D
)22D E
;22E F
if33 
(33 
usuario33 
==33 
null33 
)33  
{44 
ViewData55 
[55 
$str55 "
]55" #
=55$ %
$str55& @
;55@ A
return66 
View66 
(66 
)66 
;66 
}77 
if:: 
(:: 
usuario:: 
.:: 
IsLocked::  
)::  !
{;; 
if<< 
(<< 
usuario<< 
.<< 

LockoutEnd<< &
><<' (
DateTime<<) 1
.<<1 2
UtcNow<<2 8
)<<8 9
{== 
ViewData>> 
[>> 
$str>> &
]>>& '
=>>( )
$str>>* k
;>>k l
return?? 
View?? 
(??  
)??  !
;??! "
}@@ 
elseAA 
{BB 
awaitDD 
_usuarioDataDD &
.DD& '
ResetLockoutDD' 3
(DD3 4
usuarioDD4 ;
.DD; <
	IdUsuarioDD< E
)DDE F
;DDF G
}EE 
}FF 
ifII 
(II 
usuarioII 
.II 

LockoutEndII "
!=II# %
nullII& *
&&II+ -
usuarioII. 5
.II5 6

LockoutEndII6 @
>IIA B
DateTimeIIC K
.IIK L
UtcNowIIL R
)IIR S
{JJ 
varKK 
tiempoRestanteKK "
=KK# $
(KK% &
usuarioKK& -
.KK- .

LockoutEndKK. 8
.KK8 9
ValueKK9 >
-KK? @
DateTimeKKA I
.KKI J
UtcNowKKJ P
)KKP Q
.KKQ R
TotalSecondsKKR ^
;KK^ _
ConsoleLL 
.LL 
	WriteLineLL !
(LL! "
$"LL" $
$strLL$ 5
{LL5 6
tiempoRestanteLL6 D
}LLD E
"LLE F
)LLF G
;LLG H
ifNN 
(NN 
tiempoRestanteNN "
>NN# $
$numNN% &
)NN& '
{OO 
ViewDataPP 
[PP 
$strPP &
]PP& '
=PP( )
$"PP* ,
$strPP, =
{PP= >
(PP> ?
intPP? B
)PPB C
tiempoRestantePPC Q
}PPQ R
$strPPR y
"PPy z
;PPz {
ViewDataQQ 
[QQ 
$strQQ .
]QQ. /
=QQ0 1
(QQ2 3
intQQ3 6
)QQ6 7
MathQQ7 ;
.QQ; <
CeilingQQ< C
(QQC D
tiempoRestanteQQD R
)QQR S
;QQS T
ConsoleRR 
.RR 
	WriteLineRR %
(RR% &
$"RR& (
$strRR( :
{RR: ;
tiempoRestanteRR; I
}RRI J
"RRJ K
)RRK L
;RRL M
ConsoleSS 
.SS 
	WriteLineSS %
(SS% &
ViewDataSS& .
[SS. /
$strSS/ @
]SS@ A
)SSA B
;SSB C
returnTT 
ViewTT 
(TT  
)TT  !
;TT! "
}UU 
elseVV 
{WW 
ViewDataXX 
[XX 
$strXX .
]XX. /
=XX0 1
nullXX2 6
;XX6 7
}YY 
}ZZ 
if]] 
(]] 
string]] 
.]] 
IsNullOrEmpty]] $
(]]$ %
usuario]]% ,
.]], -
Clave]]- 2
)]]2 3
)]]3 4
{^^ 
ViewData__ 
[__ 
$str__ "
]__" #
=__$ %
$str__& T
;__T U
return`` 
View`` 
(`` 
)`` 
;`` 
}aa 
boolcc 
isPasswordValidcc  
=cc! "
BCryptcc# )
.cc) *
Netcc* -
.cc- .
BCryptcc. 4
.cc4 5
Verifycc5 ;
(cc; <
clavecc< A
,ccA B
usuarioccC J
.ccJ K
ClaveccK P
)ccP Q
;ccQ R
ifee 
(ee 
!ee 
isPasswordValidee  
)ee  !
{ff 
usuariogg 
.gg 
FailedAttemptsgg &
++gg& (
;gg( )
usuariohh 
.hh 
LastFailedAttempthh )
=hh* +
DateTimehh, 4
.hh4 5
UtcNowhh5 ;
;hh; <
intjj 
tiempoBloqueadojj #
=jj$ %
$numjj& '
;jj' (
ifkk 
(kk 
usuariokk 
.kk 
FailedAttemptskk *
==kk+ -
$numkk. /
)kk/ 0
{ll 
tiempoBloqueadomm #
=mm$ %
$nummm& (
;mm( )
usuarionn 
.nn 

LockoutEndnn &
=nn' (
DateTimenn) 1
.nn1 2
UtcNownn2 8
.nn8 9

AddSecondsnn9 C
(nnC D
tiempoBloqueadonnD S
)nnS T
;nnT U
}oo 
elsepp 
ifpp 
(pp 
usuariopp  
.pp  !
FailedAttemptspp! /
==pp0 2
$numpp3 4
)pp4 5
{qq 
tiempoBloqueadorr #
=rr$ %
$numrr& (
;rr( )
usuarioss 
.ss 

LockoutEndss &
=ss' (
DateTimess) 1
.ss1 2
UtcNowss2 8
.ss8 9

AddSecondsss9 C
(ssC D
tiempoBloqueadossD S
)ssS T
;ssT U
}tt 
elseuu 
ifuu 
(uu 
usuariouu  
.uu  !
FailedAttemptsuu! /
>=uu0 2
$numuu3 4
)uu4 5
{vv 
usuarioww 
.ww 
IsLockedww $
=ww% &
trueww' +
;ww+ ,
usuarioxx 
.xx 

LockoutEndxx &
=xx' (
DateTimexx) 1
.xx1 2
MaxValuexx2 :
;xx: ;
awaityy 
_usuarioDatayy &
.yy& '
UpdateLockoutStatusyy' :
(yy: ;
usuarioyy; B
)yyB C
;yyC D
ViewDatazz 
[zz 
$strzz &
]zz& '
=zz( )
$strzz* s
;zzs t
return{{ 
View{{ 
({{  
){{  !
;{{! "
}|| 
await~~ 
_usuarioData~~ "
.~~" #
UpdateLockoutStatus~~# 6
(~~6 7
usuario~~7 >
)~~> ?
;~~? @
if
 
(
 
tiempoBloqueado
 #
>
$ %
$num
& '
)
' (
{
 
ViewData
 
[
 
$str
 &
]
& '
=
( )
$str
* q
;
q r
ViewData
 
[
 
$str
 .
]
. /
=
0 1
tiempoBloqueado
2 A
;
A B
return
 
View
 
(
  
)
  !
;
! "
}
 
ViewData
 
[
 
$str
 "
]
" #
=
$ %
$"
& (
$str
( V
{
V W
$num
W X
-
Y Z
usuario
[ b
.
b c
FailedAttempts
c q
}
q r
"
r s
;
s t
return
 
View
 
(
 
)
 
;
 
}
 
await
 
_usuarioData
 
.
 
ResetLockout
 +
(
+ ,
usuario
, 3
.
3 4
	IdUsuario
4 =
)
= >
;
> ?
var
  
codigoVerificacion
 "
=
# $'
GenerarCodigoVerificacion
% >
(
> ?
)
? @
;
@ A
HttpContext
 
.
 
Session
 
.
  
	SetString
  )
(
) *
$str
* >
,
> ? 
codigoVerificacion
@ R
)
R S
;
S T
HttpContext
 
.
 
Session
 
.
  
	SetString
  )
(
) *
$str
* >
,
> ?
correo
@ F
)
F G
;
G H
string
 
asunto
 
=
 
$str
 4
;
4 5
string
 
mensaje
 
=
 
$"
 
$str
 =
{
= > 
codigoVerificacion
> P
}
P Q
"
Q R
;
R S
await
 
_emailService
 
.
  
EnviarCorreoAsync
  1
(
1 2
correo
2 8
,
8 9
asunto
: @
,
@ A
mensaje
B I
)
I J
;
J K
var
 
claims
 
=
 
new
 
[
 
]
 
{
 
new
 
Claim
 
(
 

ClaimTypes
 $
.
$ %
Name
% )
,
) *
usuario
+ 2
.
2 3
NombreCompleto
3 A
)
A B
,
B C
new
 
Claim
 
(
 

ClaimTypes
 $
.
$ %
NameIdentifier
% 3
,
3 4
usuario
5 <
.
< =
	IdUsuario
= F
.
F G
ToString
G O
(
O P
)
P Q
)
Q R
,
R S
new
 
Claim
 
(
 

ClaimTypes
 $
.
$ %
Email
% *
,
* +
usuario
, 3
.
3 4
Correo
4 :
)
: ;
,
; <
new
 
Claim
 
(
 

ClaimTypes
 $
.
$ %
Role
% )
,
) *
usuario
+ 2
.
2 3
Rol
3 6
)
6 7
}
 
;
 
var
¡¡ 
key
¡¡ 
=
¡¡ 
new
¡¡ "
SymmetricSecurityKey
¡¡ .
(
¡¡. /
Encoding
¡¡/ 7
.
¡¡7 8
UTF8
¡¡8 <
.
¡¡< =
GetBytes
¡¡= E
(
¡¡E F
_configuration
¡¡F T
[
¡¡T U
$str
¡¡U ^
]
¡¡^ _
!
¡¡_ `
)
¡¡` a
)
¡¡a b
;
¡¡b c
var
¢¢ 
credentials
¢¢ 
=
¢¢ 
new
¢¢ ! 
SigningCredentials
¢¢" 4
(
¢¢4 5
key
¢¢5 8
,
¢¢8 9 
SecurityAlgorithms
¢¢: L
.
¢¢L M

HmacSha256
¢¢M W
)
¢¢W X
;
¢¢X Y
var
££ 
expires
££ 
=
££ 
DateTime
££ "
.
££" #
Now
££# &
.
££& '

AddMinutes
££' 1
(
££1 2
Convert
££2 9
.
££9 :
ToDouble
££: B
(
££B C
_configuration
££C Q
[
££Q R
$str
££R _
]
££_ `
)
££` a
)
££a b
;
££b c
var
¥¥ 
token
¥¥ 
=
¥¥ 
new
¥¥ 
JwtSecurityToken
¥¥ ,
(
¥¥, -
_configuration
¦¦ 
[
¦¦ 
$str
¦¦ +
]
¦¦+ ,
,
¦¦, -
_configuration
§§ 
[
§§ 
$str
§§ -
]
§§- .
,
§§. /
claims
¨¨ 
,
¨¨ 
expires
©© 
:
©© 
expires
©©  
,
©©  ! 
signingCredentials
ªª "
:
ªª" #
credentials
ªª$ /
)
«« 
;
«« 
HttpContext
­­ 
.
­­ 
Session
­­ 
.
­­  
	SetString
­­  )
(
­­) *
$str
­­* 1
,
­­1 2
new
­­3 6%
JwtSecurityTokenHandler
­­7 N
(
­­N O
)
­­O P
.
­­P Q

WriteToken
­­Q [
(
­­[ \
token
­­\ a
)
­­a b
)
­­b c
;
­­c d
TempData
®® 
[
®® 
$str
®® 
]
®® 
=
®® 
new
®®  #%
JwtSecurityTokenHandler
®®$ ;
(
®®; <
)
®®< =
.
®®= >

WriteToken
®®> H
(
®®H I
token
®®I N
)
®®N O
;
®®O P
return
¯¯ 
RedirectToAction
¯¯ #
(
¯¯# $
$str
¯¯$ 5
)
¯¯5 6
;
¯¯6 7
}
°° 	
public
²² 
IActionResult
²² 
VerificarCodigo
²² ,
(
²², -
)
²²- .
{
³³ 	
ViewData
´´ 
[
´´ 
$str
´´ 
]
´´ 
=
´´ 
TempData
´´  (
[
´´( )
$str
´´) 0
]
´´0 1
;
´´1 2
return
µµ 
View
µµ 
(
µµ 
)
µµ 
;
µµ 
}
¶¶ 	
[
¸¸ 	
HttpPost
¸¸	 
]
¸¸ 
public
¹¹ 
async
¹¹ 
Task
¹¹ 
<
¹¹ 
IActionResult
¹¹ '
>
¹¹' ("
VerificarCodigoAsync
¹¹) =
(
¹¹= >
string
¹¹> D
codigo
¹¹E K
)
¹¹K L
{
ºº 	
var
»»  
codigoVerificacion
»» "
=
»»# $
HttpContext
»»% 0
.
»»0 1
Session
»»1 8
.
»»8 9
	GetString
»»9 B
(
»»B C
$str
»»C W
)
»»W X
;
»»X Y
var
¼¼ 
correo
¼¼ 
=
¼¼ 
HttpContext
¼¼ $
.
¼¼$ %
Session
¼¼% ,
.
¼¼, -
	GetString
¼¼- 6
(
¼¼6 7
$str
¼¼7 K
)
¼¼K L
;
¼¼L M
var
½½ 
token
½½ 
=
½½ 
HttpContext
½½ #
.
½½# $
Session
½½$ +
.
½½+ ,
	GetString
½½, 5
(
½½5 6
$str
½½6 =
)
½½= >
;
½½> ?
if
¿¿ 
(
¿¿ 
codigo
¿¿ 
==
¿¿  
codigoVerificacion
¿¿ ,
)
¿¿, -
{
ÀÀ 
var
ÁÁ 
usuario
ÁÁ 
=
ÁÁ 
_usuarioData
ÁÁ *
.
ÁÁ* +
ObtenerPorCorreo
ÁÁ+ ;
(
ÁÁ; <
correo
ÁÁ< B
!
ÁÁB C
)
ÁÁC D
.
ÁÁD E
Result
ÁÁE K
;
ÁÁK L
var
ÃÃ 
claims
ÃÃ 
=
ÃÃ 
new
ÃÃ  
List
ÃÃ! %
<
ÃÃ% &
Claim
ÃÃ& +
>
ÃÃ+ ,
{
ÄÄ 
new
ÅÅ 
Claim
ÅÅ 
(
ÅÅ 

ClaimTypes
ÅÅ (
.
ÅÅ( )
Name
ÅÅ) -
,
ÅÅ- .
usuario
ÅÅ/ 6
.
ÅÅ6 7
NombreCompleto
ÅÅ7 E
)
ÅÅE F
,
ÅÅF G
new
ÆÆ 
Claim
ÆÆ 
(
ÆÆ 

ClaimTypes
ÆÆ (
.
ÆÆ( )
Email
ÆÆ) .
,
ÆÆ. /
usuario
ÆÆ0 7
.
ÆÆ7 8
Correo
ÆÆ8 >
)
ÆÆ> ?
,
ÆÆ? @
new
ÇÇ 
Claim
ÇÇ 
(
ÇÇ 

ClaimTypes
ÇÇ (
.
ÇÇ( )
Role
ÇÇ) -
,
ÇÇ- .
usuario
ÇÇ/ 6
.
ÇÇ6 7
Rol
ÇÇ7 :
)
ÇÇ: ;
}
ÈÈ 
;
ÈÈ 
var
ÊÊ 
identity
ÊÊ 
=
ÊÊ 
new
ÊÊ "
ClaimsIdentity
ÊÊ# 1
(
ÊÊ1 2
claims
ÊÊ2 8
,
ÊÊ8 9*
CookieAuthenticationDefaults
ÊÊ: V
.
ÊÊV W"
AuthenticationScheme
ÊÊW k
)
ÊÊk l
;
ÊÊl m
var
ËË 
	principal
ËË 
=
ËË 
new
ËË  #
ClaimsPrincipal
ËË$ 3
(
ËË3 4
identity
ËË4 <
)
ËË< =
;
ËË= >
await
ÎÎ 
HttpContext
ÎÎ !
.
ÎÎ! "
SignInAsync
ÎÎ" -
(
ÎÎ- .*
CookieAuthenticationDefaults
ÏÏ 0
.
ÏÏ0 1"
AuthenticationScheme
ÏÏ1 E
,
ÏÏE F
	principal
ÐÐ 
,
ÐÐ 
new
ÑÑ &
AuthenticationProperties
ÑÑ 0
{
ÑÑ1 2
IsPersistent
ÑÑ3 ?
=
ÑÑ@ A
false
ÑÑB G
}
ÑÑH I
)
ÒÒ 
;
ÒÒ 
Response
ÕÕ 
.
ÕÕ 
Cookies
ÕÕ  
.
ÕÕ  !
Append
ÕÕ! '
(
ÕÕ' (
$str
ÕÕ( 6
,
ÕÕ6 7
token
ÕÕ8 =
!
ÕÕ= >
,
ÕÕ> ?
new
ÕÕ@ C
CookieOptions
ÕÕD Q
{
ÖÖ 
HttpOnly
×× 
=
×× 
true
×× #
,
××# $
Secure
ØØ 
=
ØØ 
true
ØØ !
}
ÙÙ 
)
ÙÙ 
;
ÙÙ 
TempData
ÚÚ 
[
ÚÚ 
$str
ÚÚ  
]
ÚÚ  !
=
ÚÚ" #
token
ÚÚ$ )
;
ÚÚ) *
await
ÛÛ 
_auditoriaService
ÛÛ '
.
ÛÛ' (
RegistrarLog
ÛÛ( 4
(
ÛÛ4 5
usuario
ÛÛ5 <
.
ÛÛ< =
Correo
ÛÛ= C
,
ÛÛC D
$str
ÛÛE W
,
ÛÛW X
$str
ÛÛY s
)
ÛÛs t
;
ÛÛt u
return
ÜÜ 
RedirectToAction
ÜÜ '
(
ÜÜ' (
$str
ÜÜ( /
,
ÜÜ/ 0
$str
ÜÜ1 7
)
ÜÜ7 8
;
ÜÜ8 9
}
ÝÝ 
else
ÞÞ 
{
ßß 
ViewData
àà 
[
àà 
$str
àà "
]
àà" #
=
àà$ %
$str
àà& I
;
ààI J
return
áá 
View
áá 
(
áá 
)
áá 
;
áá 
}
ââ 
}
ãã 	
public
åå 
async
åå 
Task
åå 
<
åå 
IActionResult
åå '
>
åå' (
Salir
åå) .
(
åå. /
)
åå/ 0
{
ææ 	
await
çç 
HttpContext
çç 
.
çç 
SignOutAsync
çç *
(
çç* +
JwtBearerDefaults
çç+ <
.
çç< ="
AuthenticationScheme
çç= Q
)
ççQ R
;
ççR S
return
èè 
RedirectToAction
èè #
(
èè# $
$str
èè$ +
,
èè+ ,
$str
èè- 4
)
èè4 5
;
èè5 6
}
éé 	
private
ëë 
string
ëë '
GenerarCodigoVerificacion
ëë 0
(
ëë0 1
)
ëë1 2
{
ìì 	
using
íí 
(
íí 
var
íí 
rng
íí 
=
íí #
RandomNumberGenerator
íí 2
.
íí2 3
Create
íí3 9
(
íí9 :
)
íí: ;
)
íí; <
{
îî 
var
ïï 
bytes
ïï 
=
ïï 
new
ïï 
byte
ïï  $
[
ïï$ %
$num
ïï% &
]
ïï& '
;
ïï' (
rng
ðð 
.
ðð 
GetBytes
ðð 
(
ðð 
bytes
ðð "
)
ðð" #
;
ðð# $
return
ññ 
BitConverter
ññ #
.
ññ# $
ToUInt32
ññ$ ,
(
ññ, -
bytes
ññ- 2
,
ññ2 3
$num
ññ4 5
)
ññ5 6
.
ññ6 7
ToString
ññ7 ?
(
ññ? @
$str
ññ@ D
)
ññD E
;
ññE F
}
òò 
}
óó 	
}
ôô 
}õõ ³U
eC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\HomeController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
[ 
	Authorize 
] 
public 

class 
HomeController 
:  !

Controller" ,
{ 
private 
readonly 
ILogger  
<  !
HomeController! /
>/ 0
_logger1 8
;8 9
private 
readonly 
ResumenData $
_resumenData% 1
;1 2
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 
ResumenClienteData +
_resumenClienteData, ?
;? @
private 
readonly 
PrestamoData %
_prestamoData& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
HomeController 
( 
ILogger %
<% &
HomeController& 4
>4 5
logger6 <
,< =
ResumenData= H
resumenDataI T
,T U
ClienteDataV a
clienteDatab m
,m n
ResumenClienteData	o  
resumenClienteData
 
,
 
PrestamoData
 ¢
prestamoData
£ ¯
,
¯ °
AuditoriaService
± Á
auditoriaService
Â Ò
)
Ò Ó
{ 	
_logger 
= 
logger 
; 
_resumenData 
= 
resumenData &
;& '
_clienteData 
= 
clienteData &
;& '
_resumenClienteData 
=  !
resumenClienteData" 4
;4 5
_prestamoData 
= 
prestamoData (
;( )
_auditoriaService   
=   
auditoriaService    0
;  0 1
}!! 	
public"" 
IActionResult"" 
Index"" "
(""" #
)""# $
{## 	
return$$ 
View$$ 
($$ 
)$$ 
;$$ 
}%% 	
public&& 
IActionResult&& 
Privacy&& $
(&&$ %
)&&% &
{'' 	
return(( 
View(( 
((( 
)(( 
;(( 
})) 	
[++ 	
ResponseCache++	 
(++ 
Duration++ 
=++  !
$num++" #
,++# $
Location++% -
=++. /!
ResponseCacheLocation++0 E
.++E F
None++F J
,++J K
NoStore++L S
=++T U
true++V Z
)++Z [
]++[ \
public,, 
IActionResult,, 
Error,, "
(,," #
),,# $
{-- 	
return.. 
View.. 
(.. 
new.. 
ErrorViewModel.. *
{..+ ,
	RequestId..- 6
=..7 8
Activity..9 A
...A B
Current..B I
?..I J
...J K
Id..K M
??..N P
HttpContext..Q \
...\ ]
TraceIdentifier..] l
}..m n
)..n o
;..o p
}// 	
[11 	
	Authorize11	 
(11 !
AuthenticationSchemes11 (
=11) *
JwtBearerDefaults11+ <
.11< = 
AuthenticationScheme11= Q
)11Q R
]11R S
[22 	
HttpGet22	 
]22 
[33 	
	Authorize33	 
(33 
Roles33 
=33 
$str33 *
)33* +
]33+ ,
public44 
async44 
Task44 
<44 
IActionResult44 '
>44' (
ObtenerResumen44) 7
(447 8
)448 9
{55 	
var77 
usuario77 
=77 
User77 
.77 
Identity77 '
!77' (
.77( )
Name77) -
;77- .
await88 
_auditoriaService88 #
.88# $
RegistrarLog88$ 0
(880 1
usuario881 8
!888 9
,889 :
$str88; K
,88K L
$str88M }
)88} ~
;88~ 
Resumen:: 
objeto:: 
=:: 
await:: "
_resumenData::# /
.::/ 0
Obtener::0 7
(::7 8
)::8 9
;::9 :
return;; 

StatusCode;; 
(;; 
StatusCodes;; )
.;;) *
Status200OK;;* 5
,;;5 6
new;;7 :
{;;; <
data;;= A
=;;B C
objeto;;D J
};;K L
);;L M
;;;M N
}<< 	
[>> 	
	Authorize>>	 
(>> !
AuthenticationSchemes>> (
=>>) *
JwtBearerDefaults>>+ <
.>>< = 
AuthenticationScheme>>= Q
)>>Q R
]>>R S
[?? 	
HttpGet??	 
]?? 
public@@ 
IActionResult@@ 
ObtenerRolUsuario@@ .
(@@. /
)@@/ 0
{AA 	
varBB 
rolesBB 
=BB 
UserBB 
.BB 
ClaimsBB #
.BB# $
WhereBB$ )
(BB) *
cBB* +
=>BB, .
cBB/ 0
.BB0 1
TypeBB1 5
==BB6 8

ClaimTypesBB9 C
.BBC D
RoleBBD H
)BBH I
.BBI J
SelectBBJ P
(BBP Q
cBBQ R
=>BBS U
cBBV W
.BBW X
ValueBBX ]
)BB] ^
.BB^ _
ToListBB_ e
(BBe f
)BBf g
;BBg h
returnCC 
OkCC 
(CC 
newCC 
{CC 
rolesCC !
}CC" #
)CC# $
;CC$ %
}DD 	
[FF 	
	AuthorizeFF	 
(FF !
AuthenticationSchemesFF (
=FF) *
JwtBearerDefaultsFF+ <
.FF< = 
AuthenticationSchemeFF= Q
)FFQ R
]FFR S
[GG 	
HttpGetGG	 
]GG 
[HH 	
	AuthorizeHH	 
(HH 
RolesHH 
=HH 
$strHH $
)HH$ %
]HH% &
publicII 
asyncII 
TaskII 
<II 
IActionResultII '
>II' (!
ObtenerResumenClienteII) >
(II> ?
intII? B

idPrestamoIIC M
)IIM N
{JJ 	
ifKK 
(KK 
!KK 

ModelStateKK 
.KK 
IsValidKK #
)KK# $
{LL 
returnMM 

BadRequestMM !
(MM! "

ModelStateMM" ,
)MM, -
;MM- .
}NN 
varOO 
usuarioOO 
=OO 
UserOO 
.OO 
IdentityOO '
!OO' (
.OO( )
NameOO) -
;OO- .
awaitPP 
_auditoriaServicePP #
.PP# $
RegistrarLogPP$ 0
(PP0 1
usuarioPP1 8
!PP8 9
,PP9 :
$strPP; R
,PPR S
$str	PPT 
)
PP 
;
PP 
varRR 
correoRR 
=RR 
UserRR 
.RR 
	FindFirstRR '
(RR' (

ClaimTypesRR( 2
.RR2 3
EmailRR3 8
)RR8 9
?RR9 :
.RR: ;
ValueRR; @
;RR@ A
ConsoleSS 
.SS 
	WriteLineSS 
(SS 
correoSS $
)SS$ %
;SS% &
ifTT 
(TT 
stringTT 
.TT 
IsNullOrEmptyTT $
(TT$ %
correoTT% +
)TT+ ,
)TT, -
{UU 
returnVV 
RedirectToActionVV '
(VV' (
$strVV( /
,VV/ 0
$strVV1 7
)VV7 8
;VV8 9
}WW 
varYY 
clienteYY 
=YY 
awaitYY 
_clienteDataYY  ,
.YY, -
ObtenerPorCorreoYY- =
(YY= >
correoYY> D
)YYD E
;YYE F
varZZ 
prestamoZZ 
=ZZ 
awaitZZ  
_prestamoDataZZ! .
.ZZ. /'
ObtenerIdPrestamoPorClienteZZ/ J
(ZZJ K
clienteZZK R
.ZZR S
	IdClienteZZS \
)ZZ\ ]
;ZZ] ^
Console[[ 
.[[ 
	WriteLine[[ 
([[ 
prestamo[[ &
)[[& '
;[[' (
if\\ 
(\\ 
cliente\\ 
!=\\ 
null\\ 
)\\  
{]] 
var^^ 
resumen^^ 
=^^ 
await^^ #
_resumenClienteData^^$ 7
.^^7 8
ObtenerResumen^^8 F
(^^F G
cliente^^G N
.^^N O
	IdCliente^^O X
,^^X Y
prestamo^^Z b
)^^b c
;^^c d
Console__ 
.__ 
	WriteLine__ !
(__! "
resumen__" )
.__) *"
PagosClientePendientes__* @
)__@ A
;__A B
Console`` 
.`` 
	WriteLine`` !
(``! "
resumen``" )
.``) *
PrestamosCliente``* :
)``: ;
;``; <
returnaa 
Okaa 
(aa 
resumenaa !
)aa! "
;aa" #
}bb 
returncc 
NotFoundcc 
(cc 
)cc 
;cc 
}dd 	
publicff 
asyncff 
Taskff 
<ff 
IActionResultff '
>ff' (
Salirff) .
(ff. /
)ff/ 0
{gg 	
varhh 
usuariohh 
=hh 
Userhh 
.hh 
Identityhh '
!hh' (
.hh( )
Namehh) -
;hh- .
awaitii 
_auditoriaServiceii #
.ii# $
RegistrarLogii$ 0
(ii0 1
usuarioii1 8
!ii8 9
,ii9 :
$strii; B
,iiB C
$striiD ^
)ii^ _
;ii_ `
awaitkk 
HttpContextkk 
.kk 
SignOutAsynckk *
(kk* +(
CookieAuthenticationDefaultskk+ G
.kkG H 
AuthenticationSchemekkH \
)kk\ ]
;kk] ^
Responsenn 
.nn 
Cookiesnn 
.nn 
Deletenn #
(nn# $
$strnn$ 2
)nn2 3
;nn3 4
Responseoo 
.oo 
Cookiesoo 
.oo 
Deleteoo #
(oo# $
$stroo$ 2
)oo2 3
;oo3 4
returnqq 
RedirectToActionqq #
(qq# $
$strqq$ +
,qq+ ,
$strqq- 4
)qq4 5
;qq5 6
}rr 	
}ss 
}tt Ý4
gC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\CuentaController.cs
	namespace

 	
Prestamo


 
.

 
Web

 
.

 
Controllers

 "
{ 
[ 
	Authorize 
] 
public 

class 
CuentaController !
:" #

Controller$ .
{ 
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 

CuentaData #
_cuentaData$ /
;/ 0
public 
CuentaController 
(  
ClienteData  +
clienteData, 7
,7 8

CuentaData9 C

cuentaDataD N
)N O
{ 	
_clienteData 
= 
clienteData &
;& '
_cuentaData 
= 

cuentaData $
;$ %
} 	
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
)/ 0
{ 	
try 
{ 
var 
correo 
= 
User !
.! "
	FindFirst" +
(+ ,

ClaimTypes, 6
.6 7
Email7 <
)< =
?= >
.> ?
Value? D
;D E
Console 
. 
	WriteLine !
(! "
$"" $
$str$ 7
{7 8
correo8 >
}> ?
"? @
)@ A
;A B
if 
( 
string 
. 
IsNullOrEmpty (
(( )
correo) /
)/ 0
)0 1
{   
Console!! 
.!! 
	WriteLine!! %
(!!% &
$str!!& J
)!!J K
;!!K L
return"" 
RedirectToAction"" +
(""+ ,
$str"", 3
,""3 4
$str""5 >
)""> ?
;""? @
}## 
var%% 
cliente%% 
=%% 
await%% #
_clienteData%%$ 0
.%%0 1
ObtenerPorCorreo%%1 A
(%%A B
correo%%B H
)%%H I
;%%I J
if'' 
('' 
cliente'' 
=='' 
null'' #
)''# $
{(( 
Console)) 
.)) 
	WriteLine)) %
())% &
$"))& (
$str))( O
{))O P
correo))P V
}))V W
"))W X
)))X Y
;))Y Z
return** 
RedirectToAction** +
(**+ ,
$str**, 3
,**3 4
$str**5 >
)**> ?
;**? @
}++ 
Console-- 
.-- 
	WriteLine-- !
(--! "
$"--" $
$str--$ ?
{--? @
cliente--@ G
.--G H
	IdCliente--H Q
}--Q R
"--R S
)--S T
;--T U
ViewBag.. 
... 
	IdCliente.. !
=.." #
cliente..$ +
...+ ,
	IdCliente.., 5
;..5 6
return00 
View00 
(00 
)00 
;00 
}11 
catch22 
(22 
	Exception22 
ex22 
)22  
{33 
Console44 
.44 
	WriteLine44 !
(44! "
$"44" $
$str44$ +
{44+ ,
ex44, .
.44. /
Message44/ 6
}446 7
"447 8
)448 9
;449 :
return55 
RedirectToAction55 '
(55' (
$str55( /
,55/ 0
$str551 :
)55: ;
;55; <
}66 
}77 	
[99 	
	Authorize99	 
(99 !
AuthenticationSchemes99 (
=99) *
JwtBearerDefaults99+ <
.99< = 
AuthenticationScheme99= Q
)99Q R
]99R S
[:: 	
HttpGet::	 
]:: 
[;; 	
	Authorize;;	 
(;; 
Roles;; 
=;; 
$str;; $
);;$ %
];;% &
public<< 
async<< 
Task<< 
<<< 
IActionResult<< '
><<' (
ObtenerCuenta<<) 6
(<<6 7
int<<7 :
	idCliente<<; D
)<<D E
{== 	
if>> 
(>> 
!>> 

ModelState>> 
.>> 
IsValid>> #
)>># $
{?? 
return@@ 

BadRequest@@ !
(@@! "

ModelState@@" ,
)@@, -
;@@- .
}AA 
ConsoleBB 
.BB 
	WriteLineBB 
(BB 
$"BB  
$strBB  C
{BBC D
	idClienteBBD M
}BBM N
"BBN O
)BBO P
;BBP Q
tryDD 
{EE 
varFF 
cuentaFF 
=FF 
awaitFF "
_cuentaDataFF# .
.FF. /
ObtenerCuentaFF/ <
(FF< =
	idClienteFF= F
)FFF G
;FFG H
ifGG 
(GG 
cuentaGG 
==GG 
nullGG "
)GG" #
{HH 
returnII 
JsonII 
(II  
newII  #
{II$ %
successII& -
=II. /
falseII0 5
,II5 6
messageII7 >
=II? @
$strIIA [
}II\ ]
)II] ^
;II^ _
}JJ 
ConsoleLL 
.LL 
	WriteLineLL !
(LL! "
$"LL" $
$strLL$ 7
{LL7 8
cuentaLL8 >
?LL> ?
.LL? @
TarjetaLL@ G
??LLH J
$strLLK Q
}LLQ R
"LLR S
)LLS T
;LLT U
returnMM 
JsonMM 
(MM 
newMM 
{MM  !
successMM" )
=MM* +
trueMM, 0
,MM0 1
dataMM2 6
=MM7 8
cuentaMM9 ?
}MM@ A
)MMA B
;MMB C
}NN 
catchOO 
(OO 
	ExceptionOO 
exOO 
)OO  
{PP 
ConsoleQQ 
.QQ 
	WriteLineQQ !
(QQ! "
$"QQ" $
$strQQ$ =
{QQ= >
exQQ> @
.QQ@ A
MessageQQA H
}QQH I
"QQI J
)QQJ K
;QQK L
returnRR 
JsonRR 
(RR 
newRR 
{RR  !
successRR" )
=RR* +
falseRR, 1
,RR1 2
messageRR3 :
=RR; <
$strRR= Y
}RRZ [
)RR[ \
;RR\ ]
}SS 
}TT 	
}VV 
}WW ßM
gC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\CobrarController.cs
	namespace		 	
Prestamo		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
	Authorize 
] 
public 

class 
CobrarController !
:" #

Controller$ .
{ 
private 
readonly 
PrestamoData %
_prestamoData& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
public 
CobrarController 
(  
PrestamoData  ,
prestamoData- 9
,9 :
AuditoriaService; K
auditoriaServiceL \
,\ ]
ClienteData^ i
clienteDataj u
)u v
{ 	
_prestamoData 
= 
prestamoData (
;( )
_auditoriaService 
= 
auditoriaService  0
;0 1
_clienteData 
= 
clienteData &
;& '
} 	
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
)/ 0
{ 	
try 
{ 
var 
correo 
= 
User !
.! "
	FindFirst" +
(+ ,

ClaimTypes, 6
.6 7
Email7 <
)< =
?= >
.> ?
Value? D
;D E
Console 
. 
	WriteLine !
(! "
$"" $
$str$ 7
{7 8
correo8 >
}> ?
"? @
)@ A
;A B
if   
(   
string   
.   
IsNullOrEmpty   (
(  ( )
correo  ) /
)  / 0
)  0 1
{!! 
Console"" 
."" 
	WriteLine"" %
(""% &
$str""& J
)""J K
;""K L
return## 
RedirectToAction## +
(##+ ,
$str##, 3
,##3 4
$str##5 >
)##> ?
;##? @
}$$ 
var&& 
cliente&& 
=&& 
await&& #
_clienteData&&$ 0
.&&0 1
ObtenerPorCorreo&&1 A
(&&A B
correo&&B H
)&&H I
;&&I J
if(( 
((( 
cliente(( 
==(( 
null(( #
)((# $
{)) 
Console** 
.** 
	WriteLine** %
(**% &
$"**& (
$str**( O
{**O P
correo**P V
}**V W
"**W X
)**X Y
;**Y Z
return++ 
RedirectToAction++ +
(+++ ,
$str++, 3
,++3 4
$str++5 >
)++> ?
;++? @
},, 
Console.. 
... 
	WriteLine.. !
(..! "
$".." $
$str..$ ?
{..? @
cliente..@ G
...G H
	IdCliente..H Q
}..Q R
"..R S
)..S T
;..T U
ViewBag// 
.// 
	IdCliente// !
=//" #
cliente//$ +
.//+ ,
	IdCliente//, 5
;//5 6
return11 
View11 
(11 
)11 
;11 
}22 
catch33 
(33 
	Exception33 
ex33 
)33  
{44 
Console55 
.55 
	WriteLine55 !
(55! "
$"55" $
$str55$ +
{55+ ,
ex55, .
.55. /
Message55/ 6
}556 7
"557 8
)558 9
;559 :
return66 
RedirectToAction66 '
(66' (
$str66( /
,66/ 0
$str661 :
)66: ;
;66; <
}77 
}88 	
[:: 	
	Authorize::	 
(:: !
AuthenticationSchemes:: (
=::) *
JwtBearerDefaults::+ <
.::< = 
AuthenticationScheme::= Q
)::Q R
]::R S
[;; 	
HttpPost;;	 
];; 
[<< 	
	Authorize<<	 
(<< 
Roles<< 
=<< 
$str<< $
)<<$ %
]<<% &
public== 
async== 
Task== 
<== 
IActionResult== '
>==' (
PagarCuotas==) 4
(==4 5
[==5 6
FromBody==6 >
]==> ?
PagarCuotasRequest==@ R
request==S Z
)==Z [
{>> 	
if?? 
(?? 
!?? 

ModelState?? 
.?? 
IsValid?? #
)??# $
{@@ 
returnAA 

BadRequestAA !
(AA! "

ModelStateAA" ,
)AA, -
;AA- .
}BB 
ifCC 
(CC 
requestCC 
==CC 
nullCC 
)CC  
{DD 
returnEE 

StatusCodeEE !
(EE! "
StatusCodesEE" -
.EE- .
Status400BadRequestEE. A
,EEA B
newEEC F
{EEG H
dataEEI M
=EEN O
$strEEP s
}EEt u
)EEu v
;EEv w
}FF 
ifHH 
(HH 
stringHH 
.HH 
IsNullOrEmptyHH $
(HH$ %
requestHH% ,
.HH, -
NumeroTarjetaHH- :
)HH: ;
)HH; <
{II 
returnJJ 

StatusCodeJJ !
(JJ! "
StatusCodesJJ" -
.JJ- .
Status400BadRequestJJ. A
,JJA B
newJJC F
{JJG H
dataJJI M
=JJN O
$strJJP s
}JJt u
)JJu v
;JJv w
}KK 
ifMM 
(MM 
requestMM 
.MM 

IdPrestamoMM "
<=MM# %
$numMM& '
)MM' (
{NN 
returnOO 

StatusCodeOO !
(OO! "
StatusCodesOO" -
.OO- .
Status400BadRequestOO. A
,OOA B
newOOC F
{OOG H
dataOOI M
=OON O
$strOOP q
}OOr s
)OOs t
;OOt u
}PP 
ifRR 
(RR 
stringRR 
.RR 
IsNullOrEmptyRR $
(RR$ %
requestRR% ,
.RR, -
NroCuotasPagadasRR- =
)RR= >
)RR> ?
{SS 
returnTT 

StatusCodeTT !
(TT! "
StatusCodesTT" -
.TT- .
Status400BadRequestTT. A
,TTA B
newTTC F
{TTG H
dataTTI M
=TTN O
$strTTP u
}TTv w
)TTw x
;TTx y
}UU 
tryWW 
{XX 
stringYY 
	respuestaYY  
=YY! "
awaitYY# (
_prestamoDataYY) 6
.YY6 7
PagarCuotasYY7 B
(YYB C
requestZZ 
.ZZ 

IdPrestamoZZ &
,ZZ& '
request[[ 
.[[ 
NroCuotasPagadas[[ ,
,[[, -
request\\ 
.\\ 
NumeroTarjeta\\ )
)]] 
;]] 
if__ 
(__ 
	respuesta__ 
.__ 

StartsWith__ (
(__( )
$str__) 0
)__0 1
||__2 4
	respuesta__5 >
.__> ?
Contains__? G
(__G H
$str__H T
)__T U
||__V X
	respuesta__Y b
.__b c
Contains__c k
(__k l
$str__l {
)__{ |
)__| }
{`` 
returnaa 

StatusCodeaa %
(aa% &
StatusCodesaa& 1
.aa1 2
Status400BadRequestaa2 E
,aaE F
newaaG J
{aaK L
dataaaM Q
=aaR S
	respuestaaaT ]
}aa^ _
)aa_ `
;aa` a
}bb 
awaitdd 
_auditoriaServicedd '
.dd' (
RegistrarLogdd( 4
(dd4 5
Userdd5 9
!dd9 :
.dd: ;
Identitydd; C
!ddC D
.ddD E
NameddE I
!ddI J
,ddJ K
$strddL S
,ddS T
$"ddU W
$strddW e
{dde f
requestddf m
.ddm n
NroCuotasPagadasddn ~
}dd~ 
"	dd 
)
dd 
;
dd 
returnee 

StatusCodeee !
(ee! "
StatusCodesee" -
.ee- .
Status200OKee. 9
,ee9 :
newee; >
{ee? @
dataeeA E
=eeF G
	respuestaeeH Q
}eeR S
)eeS T
;eeT U
}ff 
catchgg 
(gg 
	Exceptiongg 
exgg 
)gg  
{hh 
returnii 

StatusCodeii !
(ii! "
StatusCodesii" -
.ii- .(
Status500InternalServerErrorii. J
,iiJ K
newiiL O
{iiP Q
dataiiR V
=iiW X
$striiY v
+iiw x
exiiy {
.ii{ |
Message	ii| 
}
ii 
)
ii 
;
ii 
}jj 
}kk 	
publicmm 
classmm 
PagarCuotasRequestmm '
{nn 	
publicoo 
intoo 

IdPrestamooo !
{oo" #
getoo$ '
;oo' (
setoo) ,
;oo, -
}oo. /
publicpp 
stringpp 
NroCuotasPagadaspp *
{pp+ ,
getpp- 0
;pp0 1
setpp2 5
;pp5 6
}pp7 8
publicqq 
stringqq 
NumeroTarjetaqq '
{qq( )
getqq* -
;qq- .
setqq/ 2
;qq2 3
}qq4 5
}rr 	
}ss 
}tt ék
hC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\ClienteController.cs
	namespace		 	
Prestamo		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
	Authorize 
] 
public 

class 
ClienteController "
:# $

Controller% /
{ 
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 

CuentaData #
_cuentaData$ /
;/ 0
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
ClienteController  
(  !
ClienteData! ,
clienteData- 8
,8 9

CuentaData: D

cuentaDataE O
,O P
AuditoriaServiceQ a
auditoriaServiceb r
)r s
{ 	
_clienteData 
= 
clienteData &
;& '
_cuentaData 
= 

cuentaData $
;$ %
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
[ 	
	Authorize	 
( !
AuthenticationSchemes (
=) *
JwtBearerDefaults+ <
.< = 
AuthenticationScheme= Q
)Q R
]R S
[ 	
HttpGet	 
] 
[   	
	Authorize  	 
(   
Roles   
=   
$str   *
)  * +
]  + ,
public!! 
async!! 
Task!! 
<!! 
IActionResult!! '
>!!' (
Lista!!) .
(!!. /
)!!/ 0
{"" 	
List## 
<## 
Cliente## 
>## 
lista## 
=##  !
await##" '
_clienteData##( 4
.##4 5
Lista##5 :
(##: ;
)##; <
;##< =
await$$ 
_auditoriaService$$ #
.$$# $
RegistrarLog$$$ 0
($$0 1
User$$1 5
.$$5 6
Identity$$6 >
.$$> ?
Name$$? C
,$$C D
$str$$E L
,$$L M
$str$$N y
)$$y z
;$$z {
return%% 

StatusCode%% 
(%% 
StatusCodes%% )
.%%) *
Status200OK%%* 5
,%%5 6
new%%7 :
{%%; <
data%%= A
=%%B C
lista%%D I
}%%J K
)%%K L
;%%L M
}&& 	
[(( 	
	Authorize((	 
((( !
AuthenticationSchemes(( (
=(() *
JwtBearerDefaults((+ <
.((< = 
AuthenticationScheme((= Q
)((Q R
]((R S
[)) 	
HttpPost))	 
])) 
[** 	
	Authorize**	 
(** 
Roles** 
=** 
$str** *
)*** +
]**+ ,
public++ 
async++ 
Task++ 
<++ 
IActionResult++ '
>++' (
Crear++) .
(++. /
[++/ 0
FromBody++0 8
]++8 9
Cliente++: A
objeto++B H
)++H I
{,, 	
if-- 
(-- 
!-- 

ModelState-- 
.-- 
IsValid-- #
)--# $
{.. 
return// 

BadRequest// !
(//! "

ModelState//" ,
)//, -
;//- .
}00 
string11 
	respuesta11 
=11 
await11 $
_clienteData11% 1
.111 2
Crear112 7
(117 8
objeto118 >
)11> ?
;11? @
await22 
_auditoriaService22 #
.22# $
RegistrarLog22$ 0
(220 1
User221 5
.225 6
Identity226 >
.22> ?
Name22? C
,22C D
$str22E L
,22L M
$"22N P
$str22P `
{22` a
objeto22a g
.22g h
Nombre22h n
}22n o
$str22o p
{22p q
objeto22q w
.22w x
Apellido	22x 
}
22 
"
22 
)
22 
;
22 
return33 

StatusCode33 
(33 
StatusCodes33 )
.33) *
Status200OK33* 5
,335 6
new337 :
{33; <
data33= A
=33B C
	respuesta33D M
}33N O
)33O P
;33P Q
}44 	
[66 	
	Authorize66	 
(66 !
AuthenticationSchemes66 (
=66) *
JwtBearerDefaults66+ <
.66< = 
AuthenticationScheme66= Q
)66Q R
]66R S
[77 	
HttpPut77	 
]77 
[88 	
	Authorize88	 
(88 
Roles88 
=88 
$str88 *
)88* +
]88+ ,
public99 
async99 
Task99 
<99 
IActionResult99 '
>99' (
Editar99) /
(99/ 0
[990 1
FromBody991 9
]999 :
Cliente99; B
objeto99C I
)99I J
{:: 	
if;; 
(;; 
!;; 

ModelState;; 
.;; 
IsValid;; #
);;# $
{<< 
return== 

BadRequest== !
(==! "

ModelState==" ,
)==, -
;==- .
}>> 
string?? 
	respuesta?? 
=?? 
await?? $
_clienteData??% 1
.??1 2
Editar??2 8
(??8 9
objeto??9 ?
)??? @
;??@ A
await@@ 
_auditoriaService@@ #
.@@# $
RegistrarLog@@$ 0
(@@0 1
User@@1 5
.@@5 6
Identity@@6 >
.@@> ?
Name@@? C
,@@C D
$str@@E M
,@@M N
$"@@O Q
$str@@Q b
{@@b c
objeto@@c i
.@@i j
Nombre@@j p
}@@p q
$str@@q r
{@@r s
objeto@@s y
.@@y z
Apellido	@@z 
}
@@ 
"
@@ 
)
@@ 
;
@@ 
returnAA 

StatusCodeAA 
(AA 
StatusCodesAA )
.AA) *
Status200OKAA* 5
,AA5 6
newAA7 :
{AA; <
dataAA= A
=AAB C
	respuestaAAD M
}AAN O
)AAO P
;AAP Q
}BB 	
[DD 	
	AuthorizeDD	 
(DD !
AuthenticationSchemesDD (
=DD) *
JwtBearerDefaultsDD+ <
.DD< = 
AuthenticationSchemeDD= Q
)DDQ R
]DDR S
[EE 	

HttpDeleteEE	 
]EE 
[FF 	
	AuthorizeFF	 
(FF 
RolesFF 
=FF 
$strFF *
)FF* +
]FF+ ,
publicGG 
asyncGG 
TaskGG 
<GG 
IActionResultGG '
>GG' (
EliminarGG) 1
(GG1 2
intGG2 5
IdGG6 8
)GG8 9
{HH 	
ifII 
(II 
!II 

ModelStateII 
.II 
IsValidII #
)II# $
{JJ 
returnKK 

BadRequestKK !
(KK! "

ModelStateKK" ,
)KK, -
;KK- .
}LL 
stringMM 
	respuestaMM 
=MM 
awaitMM $
_clienteDataMM% 1
.MM1 2
EliminarMM2 :
(MM: ;
IdMM; =
)MM= >
;MM> ?
awaitNN 
_auditoriaServiceNN #
.NN# $
RegistrarLogNN$ 0
(NN0 1
UserNN1 5
.NN5 6
IdentityNN6 >
.NN> ?
NameNN? C
,NNC D
$strNNE O
,NNO P
$"NNQ S
$strNNS m
{NNm n
IdNNn p
}NNp q
"NNq r
)NNr s
;NNs t
returnOO 

StatusCodeOO 
(OO 
StatusCodesOO )
.OO) *
Status200OKOO* 5
,OO5 6
newOO7 :
{OO; <
dataOO= A
=OOB C
	respuestaOOD M
}OON O
)OOO P
;OOP Q
}PP 	
[RR 	
	AuthorizeRR	 
(RR 
RolesRR 
=RR 
$strRR $
)RR$ %
]RR% &
publicSS 
asyncSS 
TaskSS 
<SS 
IActionResultSS '
>SS' (
CuentaSS) /
(SS/ 0
)SS0 1
{TT 	
varUU 
correoUU 
=UU 
UserUU 
.UU 
	FindFirstUU '
(UU' (

ClaimTypesUU( 2
.UU2 3
EmailUU3 8
)UU8 9
?UU9 :
.UU: ;
ValueUU; @
;UU@ A
ConsoleVV 
.VV 
	WriteLineVV 
(VV 
correoVV $
)VV$ %
;VV% &
ifWW 
(WW 
stringWW 
.WW 
IsNullOrEmptyWW $
(WW$ %
correoWW% +
)WW+ ,
)WW, -
{XX 
returnYY 
RedirectToActionYY '
(YY' (
$strYY( /
,YY/ 0
$strYY1 7
)YY7 8
;YY8 9
}ZZ 
var\\ 
cliente\\ 
=\\ 
await\\ 
_clienteData\\  ,
.\\, -
ObtenerPorCorreo\\- =
(\\= >
correo\\> D
)\\D E
;\\E F
if]] 
(]] 
cliente]] 
==]] 
null]] 
)]]  
{^^ 
return__ 
RedirectToAction__ '
(__' (
$str__( /
,__/ 0
$str__1 7
)__7 8
;__8 9
}`` 
returnbb 
RedirectToActionbb #
(bb# $
$strbb$ +
,bb+ ,
$strbb- 5
,bb5 6
newbb7 :
{bb; <
	idClientebb= F
=bbG H
clientebbI P
.bbP Q
	IdClientebbQ Z
}bb[ \
)bb\ ]
;bb] ^
}cc 	
[ee 	
	Authorizeee	 
(ee !
AuthenticationSchemesee (
=ee) *
JwtBearerDefaultsee+ <
.ee< = 
AuthenticationSchemeee= Q
)eeQ R
]eeR S
[ff 	
HttpPostff	 
]ff 
[gg 	
	Authorizegg	 
(gg 
Rolesgg 
=gg 
$strgg $
)gg$ %
]gg% &
publichh 
asynchh 
Taskhh 
<hh 
IActionResulthh '
>hh' (
	Depositarhh) 2
(hh2 3
[hh3 4
FromBodyhh4 <
]hh< =
DepositoRequesthh> M
requesthhN U
)hhU V
{ii 	
ifjj 
(jj 
!jj 

ModelStatejj 
.jj 
IsValidjj #
)jj# $
{kk 
returnll 

BadRequestll !
(ll! "

ModelStatell" ,
)ll, -
;ll- .
}mm 
trynn 
{oo 
varpp 
	resultadopp 
=pp 
awaitpp  %
_cuentaDatapp& 1
.pp1 2
	Depositarpp2 ;
(pp; <
requestpp< C
.ppC D
	IdClienteppD M
,ppM N
requestppO V
.ppV W
MontoppW \
)pp\ ]
;pp] ^
ifqq 
(qq 
stringqq 
.qq 
IsNullOrEmptyqq (
(qq( )
	resultadoqq) 2
)qq2 3
)qq3 4
{rr 
awaitss 
_auditoriaServicess +
.ss+ ,
RegistrarLogss, 8
(ss8 9
Userss9 =
.ss= >
Identityss> F
.ssF G
NamessG K
,ssK L
$strssM X
,ssX Y
$"ssZ \
$strss\ h
{ssh i
requestssi p
.ssp q
Montossq v
}ssv w
$str	ssw 
{
ss  
request
ss  §
.
ss§ ¨
	IdCliente
ss¨ ±
}
ss± ²
"
ss² ³
)
ss³ ´
;
ss´ µ
returntt 
Jsontt 
(tt  
newtt  #
{tt$ %
successtt& -
=tt. /
truett0 4
}tt5 6
)tt6 7
;tt7 8
}uu 
elsevv 
{ww 
returnxx 
Jsonxx 
(xx  
newxx  #
{xx$ %
successxx& -
=xx. /
falsexx0 5
,xx5 6
errorxx7 <
=xx= >
	resultadoxx? H
}xxI J
)xxJ K
;xxK L
}yy 
}zz 
catch{{ 
({{ 
	Exception{{ 
ex{{ 
){{  
{|| 
return}} 

StatusCode}} !
(}}! "
$num}}" %
,}}% &
new}}' *
{}}+ ,
success}}- 4
=}}5 6
false}}7 <
,}}< =
error}}> C
=}}D E
ex}}F H
.}}H I
Message}}I P
}}}Q R
)}}R S
;}}S T
}~~ 
} 	
}
 
public
 

class
 
DepositoRequest
  
{
 
public
 
int
 
	IdCliente
 
{
 
get
 "
;
" #
set
$ '
;
' (
}
) *
public
 
decimal
 
Monto
 
{
 
get
 "
;
" #
set
$ '
;
' (
}
) *
}
 
} îW
hC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\AccountController.cs
	namespace

 	
Prestamo


 
.

 
Web

 
.

 
Controllers

 "
{ 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class 
AccountController "
:# $

Controller% /
{ 
private 
readonly 
UsuarioData $
_usuarioData% 1
;1 2
private 
readonly 
EmailService %
_emailService& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
AccountController  
(  !
UsuarioData! ,
usuarioData- 8
,8 9
EmailService: F
emailServiceG S
,S T
AuditoriaServiceU e
auditoriaServicef v
)v w
{ 	
_usuarioData 
= 
usuarioData &
;& '
_emailService 
= 
emailService (
;( )
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
[ 	
HttpGet	 
] 
public 
IActionResult 
ChangePassword +
(+ ,
), -
{ 	
return 
View 
( 
) 
; 
} 	
[   	
	Authorize  	 
(   !
AuthenticationSchemes   (
=  ) *
JwtBearerDefaults  + <
.  < = 
AuthenticationScheme  = Q
)  Q R
]  R S
[!! 	
HttpPost!!	 
]!! 
["" 	
	Authorize""	 
("" 
Roles"" 
="" 
$str"" $
)""$ %
]""% &
public## 
async## 
Task## 
<## 
IActionResult## '
>##' ('
SolicitarCodigoVerificacion##) D
(##D E
[##E F
FromBody##F N
]##N O#
ChangePasswordViewModel##P g
model##h m
)##m n
{$$ 	
if%% 
(%% 
!%% 

ModelState%% 
.%% 
IsValid%% #
)%%# $
{&& 
return'' 

BadRequest'' !
(''! "

ModelState''" ,
)'', -
;''- .
}(( 
var** 
userId** 
=** 
User** 
.** 
	FindFirst** '
(**' (

ClaimTypes**( 2
.**2 3
NameIdentifier**3 A
)**A B
?**B C
.**C D
Value**D I
;**I J
if++ 
(++ 
userId++ 
==++ 
null++ 
)++ 
{,, 
return-- 
Json-- 
(-- 
new-- 
{--  !
success--" )
=--* +
false--, 1
,--1 2
message--3 :
=--; <
$str--= U
}--V W
)--W X
;--X Y
}.. 
var00 
usuario00 
=00 
await00 
_usuarioData00  ,
.00, -
ObtenerPorId00- 9
(009 :
int00: =
.00= >
Parse00> C
(00C D
userId00D J
)00J K
)00K L
;00L M
if11 
(11 
usuario11 
==11 
null11 
)11  
{22 
return33 
Json33 
(33 
new33 
{33  !
success33" )
=33* +
false33, 1
,331 2
message333 :
=33; <
$str33= T
}33U V
)33V W
;33W X
}44 
bool66 
isPasswordValid66  
=66! "
BCrypt66# )
.66) *
Net66* -
.66- .
BCrypt66. 4
.664 5
Verify665 ;
(66; <
model66< A
.66A B
CurrentPassword66B Q
,66Q R
usuario66S Z
.66Z [
Clave66[ `
)66` a
;66a b
if77 
(77 
!77 
isPasswordValid77  
)77  !
{88 
return99 
Json99 
(99 
new99 
{99  !
success99" )
=99* +
false99, 1
,991 2
message993 :
=99; <
$str99= a
}99b c
)99c d
;99d e
}:: 
var== 
codigoVerificacion== "
===# $%
GenerarCodigoVerificacion==% >
(==> ?
)==? @
;==@ A
HttpContext>> 
.>> 
Session>> 
.>>  
	SetString>>  )
(>>) *
$str>>* >
,>>> ?
codigoVerificacion>>@ R
)>>R S
;>>S T
stringAA 
asuntoAA 
=AA 
$strAA N
;AAN O
stringBB 
mensajeBB 
=BB 
$"BB 
$strBB =
{BB= >
codigoVerificacionBB> P
}BBP Q
"BBQ R
;BBR S
awaitCC 
_emailServiceCC 
.CC  
EnviarCorreoAsyncCC  1
(CC1 2
usuarioCC2 9
.CC9 :
CorreoCC: @
,CC@ A
asuntoCCB H
,CCH I
mensajeCCJ Q
)CCQ R
;CCR S
returnDD 
JsonDD 
(DD 
newDD 
{DD 
successDD %
=DD& '
trueDD( ,
}DD- .
)DD. /
;DD/ 0
}EE 	
[GG 	
	AuthorizeGG	 
(GG !
AuthenticationSchemesGG (
=GG) *
JwtBearerDefaultsGG+ <
.GG< = 
AuthenticationSchemeGG= Q
)GGQ R
]GGR S
[HH 	
HttpPostHH	 
]HH 
[II 	
	AuthorizeII	 
(II 
RolesII 
=II 
$strII $
)II$ %
]II% &
publicJJ 
asyncJJ 
TaskJJ 
<JJ 
IActionResultJJ '
>JJ' (
ChangePasswordJJ) 7
(JJ7 8
[JJ8 9
FromBodyJJ9 A
]JJA B#
ChangePasswordViewModelJJC Z
modelJJ[ `
)JJ` a
{KK 	
ifLL 
(LL 
!LL 

ModelStateLL 
.LL 
IsValidLL #
)LL# $
{MM 
returnNN 

BadRequestNN !
(NN! "

ModelStateNN" ,
)NN, -
;NN- .
}OO 
varQQ 
userIdQQ 
=QQ 
UserQQ 
.QQ 
	FindFirstQQ '
(QQ' (

ClaimTypesQQ( 2
.QQ2 3
NameIdentifierQQ3 A
)QQA B
?QQB C
.QQC D
ValueQQD I
;QQI J
ifRR 
(RR 
userIdRR 
==RR 
nullRR 
)RR 
{SS 
returnTT 
JsonTT 
(TT 
newTT 
{TT  !
successTT" )
=TT* +
falseTT, 1
,TT1 2
messageTT3 :
=TT; <
$strTT= U
}TTV W
)TTW X
;TTX Y
}UU 
varWW 
usuarioWW 
=WW 
awaitWW 
_usuarioDataWW  ,
.WW, -
ObtenerPorIdWW- 9
(WW9 :
intWW: =
.WW= >
ParseWW> C
(WWC D
userIdWWD J
)WWJ K
)WWK L
;WWL M
ifXX 
(XX 
usuarioXX 
==XX 
nullXX 
)XX  
{YY 
returnZZ 
JsonZZ 
(ZZ 
newZZ 
{ZZ  !
successZZ" )
=ZZ* +
falseZZ, 1
,ZZ1 2
messageZZ3 :
=ZZ; <
$strZZ= T
}ZZU V
)ZZV W
;ZZW X
}[[ 
var]] 
codigoVerificacion]] "
=]]# $
HttpContext]]% 0
.]]0 1
Session]]1 8
.]]8 9
	GetString]]9 B
(]]B C
$str]]C W
)]]W X
;]]X Y
if^^ 
(^^ 
model^^ 
.^^ 
VerificationCode^^ &
!=^^' )
codigoVerificacion^^* <
)^^< =
{__ 
return`` 
Json`` 
(`` 
new`` 
{``  !
success``" )
=``* +
false``, 1
,``1 2
message``3 :
=``; <
$str``= f
}``g h
)``h i
;``i j
}aa 
trycc 
{dd 
usuarioee 
.ee 
Claveee 
=ee 
BCryptee  &
.ee& '
Netee' *
.ee* +
BCryptee+ 1
.ee1 2
HashPasswordee2 >
(ee> ?
modelee? D
.eeD E
NewPasswordeeE P
)eeP Q
;eeQ R
awaitff 
_usuarioDataff "
.ff" #

Actualizarff# -
(ff- .
usuarioff. 5
)ff5 6
;ff6 7
awaitgg 
_auditoriaServicegg '
.gg' (
RegistrarLoggg( 4
(gg4 5
Usergg5 9
.gg9 :
Identitygg: B
.ggB C
NameggC G
,ggG H
$strggI Q
,ggQ R
$"ggS U
$strggU i
{ggi j
usuarioggj q
.ggq r
Claveggr w
}ggw x
"ggx y
)ggy z
;ggz {
returnii 
Jsonii 
(ii 
newii 
{ii  !
successii" )
=ii* +
trueii, 0
}ii1 2
)ii2 3
;ii3 4
}jj 
catchkk 
(kk 
	Exceptionkk 
exkk 
)kk  
{ll 
returnmm 
Jsonmm 
(mm 
newmm 
{mm  !
successmm" )
=mm* +
falsemm, 1
,mm1 2
messagemm3 :
=mm; <
exmm= ?
.mm? @
Messagemm@ G
}mmH I
)mmI J
;mmJ K
}nn 
}oo 	
privateqq 
stringqq %
GenerarCodigoVerificacionqq 0
(qq0 1
)qq1 2
{rr 	
usingss 
(ss 
varss 
rngss 
=ss !
RandomNumberGeneratorss 2
.ss2 3
Createss3 9
(ss9 :
)ss: ;
)ss; <
{tt 
varuu 
bytesuu 
=uu 
newuu 
byteuu  $
[uu$ %
$numuu% &
]uu& '
;uu' (
rngvv 
.vv 
GetBytesvv 
(vv 
bytesvv "
)vv" #
;vv# $
returnww 
BitConverterww #
.ww# $
ToUInt32ww$ ,
(ww, -
bytesww- 2
,ww2 3
$numww4 5
)ww5 6
.ww6 7
ToStringww7 ?
(ww? @
$strww@ D
)wwD E
;wwE F
}xx 
}yy 	
}zz 
}{{ 